<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Hostal Carrales - Sistema de Fichaje Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* La advertencia de Tailwind sobre CDN es normal en desarrollo, no afecta la funcionalidad */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .gradient-bg {
            background: var(--primary-gradient);
        }
        
        .card-shadow {
            box-shadow: var(--shadow-md);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        
        .card-shadow:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            transition: var(--transition);
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: var(--success-gradient);
            transition: var(--transition);
            border-radius: var(--border-radius);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            transition: var(--transition);
            border-radius: var(--border-radius);
        }
        
        .time-display {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .scale-in {
            animation: scaleIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .clock-container {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.08),
                0 8px 16px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .employee-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            transition: var(--transition);
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .employee-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }
        
        .employee-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(102, 126, 234, 0.2);
        }
        
        .employee-card:hover::before {
            opacity: 1;
        }
        
        .nav-pill {
            border-radius: 20px;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
            cursor: pointer;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .nav-pill.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .nav-pill:not(.active) {
            background: rgba(243, 244, 246, 0.8);
            color: #6b7280;
            backdrop-filter: blur(10px);
        }
        
        .nav-pill:not(.active):hover {
            background: rgba(229, 231, 235, 0.9);
            transform: translateY(-1px);
        }
        
        .table-modern {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .input-modern {
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: var(--border-radius);
            padding: 0.875rem 1rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            font-weight: 400;
        }
        
        .input-modern:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
            outline: none;
            background: white;
        }
        
        .input-modern:hover:not(:focus) {
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 420px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notification.success {
            background: var(--success-gradient);
        }
        
        .notification.error {
            background: var(--danger-gradient);
        }
        
        .notification.warning {
            background: var(--warning-gradient);
        }
        
        @keyframes slideInRight {
            from { 
                transform: translateX(100%) scale(0.9); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .loading-spinner {
            border: 3px solid rgba(243, 244, 246, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: var(--transition);
            border: 1px solid rgba(226, 232, 240, 0.5);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--success-gradient);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            animation: pulse 3s ease-in-out infinite;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .sync-indicator.syncing {
            background: var(--warning-gradient);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .sync-indicator.error {
            background: var(--danger-gradient);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        
        .location-status {
            position: fixed;
            bottom: 80px;
            right: 24px;
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .location-status.success {
            background: var(--success-gradient);
        }
        
        .location-status.error {
            background: var(--danger-gradient);
        }
        
        /* Responsive Design Improvements */
        @media (max-width: 768px) {
            .sync-indicator,
            .location-status {
                right: 16px;
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
            
            .location-status {
                bottom: 70px;
            }
            
            .notification {
                right: 16px;
                top: 16px;
                max-width: calc(100vw - 32px);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full" style="overflow-x: hidden;">
    <div id="syncIndicator" class="sync-indicator">
        üíæ Sistema Listo
    </div>

    <div id="locationStatusIndicator" class="location-status hidden">
        üìç Verificando ubicaci√≥n...
    </div>

    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Horas Happy Hostal Carrales</h1>
                        <p class="text-sm opacity-90">Sistema de Fichaje con Control de Ubicaci√≥n</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div id="currentTime" class="text-lg font-bold time-display"></div>
                        <div id="currentDate" class="text-sm opacity-90"></div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="helpBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-full">
                            ‚ùì
                        </button>
                        <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-full">
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="loginScreen" class="min-h-screen flex items-center justify-center py-12 px-4">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl card-shadow p-8 fade-in">
                <div class="text-center mb-8">
                    <div class="gradient-bg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900">Acceso al Sistema</h2>
                    <p class="text-gray-600 mt-2">Seleccione su tipo de usuario</p>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Tipo de Usuario</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" id="adminBtn" class="user-type-btn p-4 border-2 border-gray-200 rounded-xl text-center hover:border-purple-500 transition-all">
                                <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                </svg>
                                <div class="font-medium">Administrador</div>
                            </button>
                            <button type="button" id="employeeBtn" class="user-type-btn p-4 border-2 border-gray-200 rounded-xl text-center hover:border-purple-500 transition-all">
                                <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                                </svg>
                                <div class="font-medium">Empleado</div>
                            </button>
                        </div>
                    </div>

                    <div id="adminLogin" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a de Administrador</label>
                        <input type="password" id="adminPassword" class="input-modern w-full" placeholder="Ingrese su contrase√±a">
                    </div>

                    <div id="employeeLogin" class="hidden">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üì± C√≥digo PIN</label>
                            <input type="password" id="employeeCode" class="input-modern w-full text-center text-2xl tracking-widest" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4">
                        </div>
                    </div>

                    <button id="loginButton" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                        üöÄ Iniciar Sesi√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-2 py-4 overflow-x-auto">
                    <button class="nav-tab nav-pill active" data-tab="dashboard">
                        ‚è∞ Fichaje
                    </button>
                    <button class="nav-tab nav-pill admin-only" data-tab="employees">
                        üë• Empleados
                    </button>
                    <button class="nav-tab nav-pill" data-tab="records">
                        üìã Registros
                    </button>
                    <button class="nav-tab nav-pill admin-only" data-tab="reports">
                        üìà Informes
                    </button>
                    <button class="nav-tab nav-pill admin-only" data-tab="settings">
                        ‚öôÔ∏è Configuraci√≥n
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <div id="dashboardTab" class="tab-content active fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="clock-container text-center">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">üïê Reloj de Fichaje</h3>
                            <div id="mainClock" class="text-4xl font-bold text-purple-600 mb-2 time-display"></div>
                            <div id="mainDate" class="text-gray-600 mb-6"></div>
                            
                            <div id="employeeLocationStatus" class="employee-only mb-4 p-3 rounded-xl bg-blue-50 border border-blue-200 hidden">
                                <div class="text-sm font-semibold text-blue-800 mb-1">üìç Estado de Ubicaci√≥n:</div>
                                <div id="locationStatusText" class="text-sm text-blue-600">Verificando...</div>
                            </div>
                            
                            <div id="employeeStatus" class="employee-only mb-6 p-4 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50" style="display: none;">
                                <div class="text-lg font-semibold mb-2">Estado Actual:</div>
                                <div id="currentStatus" class="text-2xl font-bold mb-2"></div>
                                <div id="statusTime" class="text-sm text-gray-600"></div>
                            </div>
                            
                            <div class="admin-only mb-4">
                                <select id="clockEmployeeSelect" class="input-modern w-full">
                                    <option value="">Seleccionar empleado</option>
                                </select>
                            </div>
                            
                            <div id="locationRefreshContainer" class="employee-only mb-4 hidden">
                                <button id="refreshLocationBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl transition-colors">
                                    üìç Actualizar Ubicaci√≥n
                                </button>
                            </div>

                            <div id="employeeNameDisplay" class="employee-only text-4xl font-extrabold text-purple-700 mb-6 hidden">
                                </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="clockInBtn" class="btn-success text-white font-bold py-4 px-6 rounded-xl">
                                    ‚úÖ ENTRADA
                                </button>
                                <button id="clockOutBtn" class="btn-danger text-white font-bold py-4 px-6 rounded-xl">
                                    üèÅ SALIDA
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl card-shadow p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Resumen de Hoy</h3>
                            <div id="todaySummary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                </div>
                        </div>
                        
                        <div id="workingHoursProgress" class="employee-only mt-6 bg-white rounded-2xl card-shadow p-6 hidden">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">‚è∞ Progreso de Jornada</h3>
                            <div id="progressContent">
                                </div>
                        </div>
                        
                        <div class="mt-6 bg-white rounded-2xl card-shadow p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">üîÑ Actividad Reciente</h3>
                            <div id="recentActivity" class="space-y-3">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="employeesTab" class="tab-content">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üë• Gesti√≥n de Empleados</h3>
                        <button id="addEmployeeBtn" class="btn-primary text-white px-4 py-2 rounded-lg">
                            ‚ûï Nuevo Empleado
                        </button>
                    </div>

                    <div id="employeesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>

            <div id="recordsTab" class="tab-content">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üìã Registros de Fichaje</h3>
                        <div class="flex space-x-2">
                            
                            <button id="addManualRecord" class="btn-primary text-white px-4 py-2 rounded-lg admin-only">
                                ‚ûï Registro Manual
                            </button>
                            <button id="exportRecords" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg admin-only">
                                üìä Exportar
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 admin-only">
                        <select id="filterEmployee" class="input-modern">
                            <option value="">Todos los empleados</option>
                        </select>
                        <input type="date" id="filterStartDate" class="input-modern">
                        <input type="date" id="filterEndDate" class="input-modern">
                        <button id="applyFilters" class="btn-primary text-white px-4 py-2 rounded-lg">
                            üîç Filtrar
                        </button>
                    </div>

                    <div class="table-modern overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="gradient-bg text-white">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">üë§ Empleado</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">üìÖ Fecha</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">üïê Entrada</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">üïï Salida</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">‚è±Ô∏è Total</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">üìä Estado</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold admin-only">‚öôÔ∏è Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="timeRecordsTable" class="divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üìä Generador de Informes</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Empleado</label>
                                <select id="reportEmployee" class="input-modern w-full">
                                    <option value="">Todos los empleados</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Fecha Inicio</label>
                                    <input type="date" id="reportStartDate" class="input-modern w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Fecha Fin</label>
                                    <input type="date" id="reportEndDate" class="input-modern w-full">
                                </div>
                            </div>
                            <button id="generateReport" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                üöÄ Generar Informe
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üìà Estad√≠sticas</h3>
                        <div id="statisticsContainer" class="space-y-4">
                            </div>
                    </div>
                </div>

                <div class="mt-8 bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">üìã Resultados del Informe</h3>
                        
                        <button id="exportReportBtn" onclick="exportReportData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors admin-only hidden">
                            üìä Exportar Informe
                        </button>
                    </div>
                    <div id="reportResults">
                        <p class="text-gray-500 text-center py-12">üìä Genere un informe para ver los resultados aqu√≠</p>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="space-y-8">
                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üè¢ Configuraci√≥n de la Empresa</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üè¢ Nombre de la Empresa</label>
                                <input type="text" id="companyName" class="input-modern w-full" value="Happy Hostal Carrales">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üÜî CIF/NIF</label>
                                <input type="text" id="companyCIF" class="input-modern w-full" value="B12345678">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìç Direcci√≥n</label>
                                <input type="text" id="companyAddress" class="input-modern w-full" value="Calle Ejemplo, 123, 28001 Madrid">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìû Tel√©fono</label>
                                <input type="text" id="companyPhone" class="input-modern w-full" value="+34 912 345 678">
                            </div>
                        </div>
                        
                        <button id="saveCompanySettings" class="mt-6 btn-primary text-white px-6 py-2 rounded-lg">
                            üíæ Guardar Configuraci√≥n
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üîê Credenciales de Administrador</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Nombre de Usuario</label>
                                <input type="text" id="adminUsername" class="input-modern w-full" value="admin">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üîí Contrase√±a Actual</label>
                                <input type="password" id="currentAdminPassword" class="input-modern w-full" placeholder="Contrase√±a actual">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üîë Nueva Contrase√±a</label>
                                <input type="password" id="newAdminPassword" class="input-modern w-full" placeholder="Nueva contrase√±a">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üîë Confirmar Contrase√±a</label>
                                <input type="password" id="confirmAdminPassword" class="input-modern w-full" placeholder="Confirmar nueva contrase√±a">
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-sm text-yellow-800">
                                <strong>‚ö†Ô∏è Importante:</strong> Guarde sus nuevas credenciales en un lugar seguro. Si las olvida, no podr√° acceder como administrador.
                            </p>
                        </div>
                        
                        <button id="saveAdminCredentials" class="mt-6 btn-primary text-white px-6 py-2 rounded-lg">
                            üîê Actualizar Credenciales
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üìç Control de Ubicaci√≥n</h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">‚ÑπÔ∏è Informaci√≥n</h4>
                                <p class="text-sm text-blue-700 mb-2">
                                    El control de ubicaci√≥n permite que los empleados solo puedan fichar cuando est√©n f√≠sicamente en el lugar de trabajo.
                                </p>
                                <ul class="text-xs text-blue-600 space-y-1 ml-4">
                                    <li>‚Ä¢ Los administradores pueden fichar desde cualquier ubicaci√≥n</li>
                                    <li>‚Ä¢ Los empleados necesitan estar dentro del radio configurado</li>
                                    <li>‚Ä¢ Se requieren permisos de ubicaci√≥n en el navegador</li>
                                </ul>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="enableLocationControl" class="rounded">
                                    <span class="text-sm font-semibold">Activar Control de Ubicaci√≥n para Empleados</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìç Direcci√≥n del Trabajo</label>
                                <input type="text" id="workAddress" class="input-modern w-full" placeholder="Direcci√≥n del lugar de trabajo">
                                <p class="text-xs text-gray-500 mt-1">Descripci√≥n opcional del lugar de trabajo</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üåç Latitud del Trabajo</label>
                                    <input type="number" id="workLatitude" class="input-modern w-full" step="0.000001" placeholder="40.416775">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üåç Longitud del Trabajo</label>
                                    <input type="number" id="workLongitude" class="input-modern w-full" step="0.000001" placeholder="-3.703790">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìè Radio Permitido: <span id="radiusValue">100</span> metros</label>
                                <input type="range" id="allowedRadius" class="w-full" min="10" max="500" value="100" oninput="document.getElementById('radiusValue').textContent = this.value">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>10m (muy estricto)</span>
                                    <span>500m (flexible)</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <button id="getCurrentLocation" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    üìç Obtener Ubicaci√≥n Actual
                                </button>
                                <button id="testDistance" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    üéØ Probar Distancia
                                </button>
                                <button id="saveLocationSettings" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">
                                    üíæ Guardar Configuraci√≥n
                                </button>
                            </div>
                            
                            <div id="locationStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600 hidden">
                                Pruebe la distancia para ver el estado
                            </div>
                            
                            <div id="locationControlStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600">
                                Estado: Control desactivado
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">‚òÅÔ∏è Sincronizaci√≥n en la Nube (Firebase)</h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">‚ÑπÔ∏è Informaci√≥n</h4>
                                <p class="text-sm text-blue-700 mb-2">
                                    **La sincronizaci√≥n de fichaje usa Firebase Realtime Database para la funci√≥n en tiempo real.**
                                </p>
                                <ul class="text-xs text-blue-600 space-y-1 ml-4">
                                    <li>‚Ä¢ El sistema de sincronizaci√≥n es **instant√°neo** y guarda los datos de forma persistente.</li>
                                    <li>‚Ä¢ La configuraci√≥n de JSONBin.io de abajo ya no tiene efecto y est√° deshabilitada.</li>
                                </ul>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üîë API Key de JSONBin.io</label>
                                    <input type="password" id="cloudApiKey" class="input-modern w-full" placeholder="Ingrese su API Key" disabled>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">üÜî Bin ID</label>
                                    <input type="text" id="cloudBinId" class="input-modern w-full" placeholder="ID del bin de datos" disabled>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="enableAutoSync" class="rounded" checked disabled>
                                    <span class="text-sm font-semibold">Sincronizaci√≥n Autom√°tica (Siempre activa con Firebase)</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‚è±Ô∏è Intervalo de Sincronizaci√≥n: <span id="syncIntervalValue">Tiempo Real</span></label>
                                <input type="range" id="syncInterval" class="w-full" min="1" max="60" value="5" disabled>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <button id="testCloudConnection" onclick="testCloudConnection()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    üîó Probar Conexi√≥n
                                </button>
                                <button id="syncNow" onclick="syncNow()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    ‚òÅÔ∏è Forzar Guardado
                                </button>
                                <button id="saveCloudSettings" class="btn-primary text-white px-4 py-2 rounded-lg text-sm" disabled>
                                    üíæ Guardar Configuraci√≥n
                                </button>
                            </div>
                            
                            <div id="cloudStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600 hidden">
                                Pruebe la conexi√≥n para ver el estado
                            </div>
                            
                            <div id="cloudSyncStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600">
                                Estado: Sincronizaci√≥n desactivada
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">üíæ Gesti√≥n de Datos</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="exportAllData" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-center transition-colors">
                                <div class="text-lg">üìÅ</div>
                                <div class="text-sm">Exportar Todo</div>
                            </button>
                            
                            <label for="importDataFile" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg text-center cursor-pointer transition-colors">
                                <div class="text-lg">üìÇ</div>
                                <div class="text-sm">Importar Datos</div>
                                <input type="file" id="importDataFile" class="hidden" accept=".json">
                            </label>
                            
                            <button id="clearAllData" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg text-center transition-colors">
                                <div class="text-lg">üóëÔ∏è</div>
                                <div class="text-sm">Limpiar Todo</div>
                            </button>
                        </div>
                        
                        <div id="dataStatistics" class="mt-6 p-4 bg-gray-50 rounded-xl">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">üë§ Nuevo Empleado</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Nombre *</label>
                    <input type="text" id="employeeName" class="input-modern w-full" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Apellidos *</label>
                    <input type="text" id="employeeLastName" class="input-modern w-full" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üÜî DNI/NIE *</label>
                    <input type="text" id="employeeDNI" class="input-modern w-full" placeholder="12345678A" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üíº Puesto</label>
                    <input type="text" id="employeePosition" class="input-modern w-full">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">‚è∞ Jornada Diaria</label>
                        <select id="employeeWorkingHours" class="input-modern w-full">
                            <option value="8">8 horas (Completa)</option>
                            <option value="7">7 horas</option>
                            <option value="6">6 horas</option>
                            <option value="5">5 horas</option>
                            <option value="4">4 horas (Media jornada)</option>
                            <option value="3">3 horas</option>
                            <option value="2">2 horas</option>
                            <option value="custom">Personalizada</option>
                        </select>
                    </div>
                    <div id="customHoursContainer" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Horas Personalizadas</label>
                        <input type="number" id="employeeCustomHours" class="input-modern w-full" min="0.5" max="12" step="0.5" placeholder="Ej: 6.5">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üì± C√≥digo PIN *</label>
                    <div class="flex space-x-2">
                        <input type="text" id="employeeAccessCode" class="input-modern flex-1 text-center text-lg tracking-widest" placeholder="1234" maxlength="4" pattern="[0-9]{4}" required>
                        <button type="button" onclick="document.getElementById('employeeAccessCode').value = generateRandomPIN(); UI.showNotification('üé≤ PIN generado autom√°ticamente', 'success');" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                            üé≤ Auto
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">C√≥digo de 4 d√≠gitos para el empleado</p>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button id="cancelEmployee" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ‚ùå Cancelar
                </button>
                <button id="saveEmployee" class="btn-primary text-white px-6 py-2 rounded-lg">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <div id="manualRecordModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">‚úèÔ∏è Registro Manual</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Empleado *</label>
                    <select id="manualRecordEmployee" class="input-modern w-full" required>
                        <option value="">Seleccionar empleado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Fecha *</label>
                    <input type="date" id="manualRecordDate" class="input-modern w-full" required>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Hora de Entrada</label>
                    <input type="time" id="manualRecordTimeIn" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üïï Hora de Salida</label>
                    <input type="time" id="manualRecordTimeOut" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìù Notas</label>
                    <textarea id="manualRecordNotes" class="input-modern w-full" rows="3" placeholder="Motivo del registro manual..."></textarea>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button id="cancelManualRecord" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ‚ùå Cancelar
                </button>
                <button id="saveManualRecord" class="btn-primary text-white px-6 py-2 rounded-lg">
                    üíæ Guardar Registro
                </button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">‚ùì Ayuda y Atajos de Teclado</h3>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <h4 class="font-bold text-gray-800 mb-3">‚å®Ô∏è Atajos de Teclado</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>**Modo Edici√≥n** (PIN: 1010)</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Login Admin</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Nuevo empleado</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Ctrl + E</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Registro manual</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Ctrl + R</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Guardar datos</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Ctrl + S</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Cerrar modales</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Escape</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                            <span>Fichar entrada (empleados)</span>
                            <kbd class="px-2 py-1 bg-green-200 rounded text-xs">F1</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-red-50 rounded">
                            <span>Fichar salida (empleados)</span>
                            <kbd class="px-2 py-1 bg-red-200 rounded text-xs">F2</kbd>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-800 mb-3">üîß Funciones Principales</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-start space-x-2">
                            <span><strong>Fichaje:</strong> Los empleados pueden fichar entrada/salida con su PIN</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span><strong>Control de ubicaci√≥n:</strong> Verificaci√≥n GPS opcional para empleados</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span><strong>Sincronizaci√≥n:</strong> Datos autom√°ticamente sincronizados en la nube</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span><strong>Informes:</strong> Generaci√≥n de reportes y estad√≠sticas</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span><strong>Seguridad:</strong> Auto-logout por inactividad (30 min)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end">
                <button id="closeHelp" class="btn-primary text-white px-6 py-2 rounded-lg">
                    ‚úÖ Entendido
                </button>
            </div>
        </div>
    </div>

    <div id="editRecordModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">‚úèÔ∏è Editar Registro</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üë§ Empleado</label>
                    <input type="text" id="editRecordEmployeeName" class="input-modern w-full" readonly>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìÖ Fecha</label>
                    <input type="date" id="editRecordDate" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üïê Hora de Entrada</label>
                    <input type="time" id="editRecordTimeIn" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üïï Hora de Salida</label>
                    <input type="time" id="editRecordTimeOut" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">üìù Notas (Motivo de la Edici√≥n)</label>
                    <textarea id="editRecordNotes" class="input-modern w-full" rows="3" placeholder="Motivo del registro manual..."></textarea>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button id="deleteRecord" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                    üóëÔ∏è Eliminar
                </button>
                <button id="cancelEditRecord" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ‚ùå Cancelar
                </button>
                <button id="saveEditRecord" class="btn-primary text-white px-6 py-2 rounded-lg">
                    üíæ Actualizar
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // =========================================================================
        // 1. DEFINICI√ìN DE VARIABLES Y FUNCIONES GLOBALES (HOISTING-SAFE)
        // =========================================================================
        
        // Declaraci√≥n de variables globales cr√≠ticas
        let employees;
        let timeRecords;
        let companySettings;
        let locationSettings;
        let adminCredentials;
        let currentUser = null;
        let selectedUserType = null;
        let editingRecordId = null;
        let editingEmployeeId = null;
        let isEditModeActive = false;
        const ADMIN_EDIT_PASSWORD = '1010';
        const appState = { lastReportData: [], lastRecordsData: [] };

        // Inicializaci√≥n de Firebase y referencias (al ser constantes, no hay problema de Hoisting)
        const firebaseConfig = {
            apiKey: "AIzaSyA3D7fH6QpdG7mUSNhFfUzD6RWje8TpGEk",
            authDomain: "hostaldatossincro.firebaseapp.com",
            databaseURL: "https://hostaldatossincro-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hostaldatossincro",
            storageBucket: "hostaldatossincro.firebasedatorage.app",
            messagingSenderId: "955112940193",
            appId: "1:955112940193:web:f30f52858c1e6c0ddc46e0"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const refEmpleados = db.ref('fichaje/employees');
        const refRegistros = db.ref('fichaje/timeRecords');
        const refConfig = db.ref('fichaje/config');


        // Funciones de Utilidad (Declaradas como funciones est√°ndar para Hoisting)
        function formatDate(date) { return date.toISOString().split('T')[0]; }
        function formatDateDisplay(dateString) { return new Date(dateString).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' }); }
        function calculateExtraHours(totalHoursDecimal, expectedHours = 8) { return Math.max(0, totalHoursDecimal - expectedHours); }
        function formatHoursToHHMM(hoursDecimal) {
            if (hoursDecimal === null || hoursDecimal === undefined || isNaN(hoursDecimal)) { return '00:00'; }
            const totalMinutes = Math.round(hoursDecimal * 60);
            const sign = totalMinutes < 0 ? "-" : "";
            const absTotalMinutes = Math.abs(totalMinutes);
            const hours = Math.floor(absTotalMinutes / 60);
            const minutes = absTotalMinutes % 60;
            const hoursStr = String(hours).padStart(2, '0');
            const minutesStr = String(minutes).padStart(2, '0');
            return `${sign}${hoursStr}:${minutesStr}`;
        }
        function calculateHours(timeIn, timeOut) {
            const [inHour, inMinute] = timeIn.split(':').map(Number);
            const [outHour, outMinute] = timeOut.split(':').map(Number);
            const inMinutes = inHour * 60 + inMinute;
            const outMinutes = outHour * 60 + outMinute;
            let diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60; 
            return diffMinutes / 60;
        }
        function validateTimeRange(timeIn, timeOut) {
            if (!timeIn || !timeOut) return true;
            const inMinutes = parseInt(timeIn.split(':')[0]) * 60 + parseInt(timeIn.split(':')[1]);
            const outMinutes = parseInt(timeOut.split(':')[0]) * 60 + parseInt(timeOut.split(':')[1]);
            let diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60; 
            return diffMinutes <= 16 * 60;
        }
        function validateDNI_NIE_Passport(doc) {
            doc = doc.toUpperCase().replace(/\s/g, ''); 
            const dniRegex = /^(\d{8})([A-Z])$/;
            const nieRegex = /^([XYZ])(\d{7})([A-Z])$/;
            const dniLetters = 'TRWAGMYFPDXBNJZSQVHLCKE';
            if (dniRegex.test(doc)) {
                const parts = doc.match(dniRegex);
                const number = parseInt(parts[1]);
                const letter = parts[2];
                return letter === dniLetters[number % 23];
            }
            if (nieRegex.test(doc)) {
                const parts = doc.match(nieRegex);
                const prefixMap = { 'X': '0', 'Y': '1', 'Z': '2' };
                const number = parseInt(prefixMap[parts[1]] + parts[2]);
                return parts[3] === dniLetters[number % 23];
            }
            const passportRegex = /^[A-Z0-9]{6,12}$/;
            return passportRegex.test(doc);
        }
        function validateDNI(dni) { return validateDNI_NIE_Passport(dni); }

        function showConfirmDialog(message) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.zIndex = '9999';
            const modal = document.createElement('div');
            modal.className = 'modal-content';
            modal.style.maxWidth = '400px';
            modal.innerHTML = `
                <div class="gradient-bg text-white p-6 rounded-t-2xl">
                    <h3 class="text-xl font-bold">‚ö†Ô∏è Confirmaci√≥n</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-700 mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirmCancel" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">‚ùå Cancelar</button>
                        <button id="confirmAccept" class="btn-primary text-white px-6 py-2 rounded-lg">‚úÖ Confirmar</button>
                    </div>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            return new Promise((resolve) => {
                document.getElementById('confirmCancel')?.addEventListener('click', () => { overlay.remove(); resolve(false); });
                document.getElementById('confirmAccept')?.addEventListener('click', () => { overlay.remove(); resolve(true); });
                overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.remove(); resolve(false); } });
            });
        }
        
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // =========================================================================
        // 2. M√ìDULOS DE DATOS Y ESTADO (Definiciones completas)
        // =========================================================================

        const DataManager = {
            getAdminCredentials() {
                const storedCredentials = localStorage.getItem('fichajemax_adminCredentials');
                if (storedCredentials && storedCredentials !== 'undefined') {
                    try { return JSON.parse(storedCredentials); } catch (e) { return { username: 'admin', password: 'Octubre2012' }; }
                }
                return { username: 'admin', password: 'Octubre2012' };
            },
            setAdminCredentials(credentials) { localStorage.setItem('fichajemax_adminCredentials', JSON.stringify(credentials)); },
            
            getEmployees() {
                const storedEmployees = localStorage.getItem('fichajemax_employees');
                if (storedEmployees && storedEmployees !== 'undefined') {
                    try { return JSON.parse(storedEmployees); } catch (e) { return this.getDefaultEmployees(); }
                }
                return this.getDefaultEmployees();
            },
            setEmployees(newEmployees) {
                localStorage.setItem('fichajemax_employees', JSON.stringify(newEmployees));
                employees = newEmployees; 
                refEmpleados.set(newEmployees).catch(error => console.error("Error al sincronizar empleados:", error));
            },
            
            getDefaultEmployees() {
                return [
                    { id: 1, name: 'Ana', lastName: 'Garc√≠a Mart√≠nez', dni: '12345678A', position: 'Recepcionista', status: 'Activo', accessCode: '1234', workingHours: 8, createdAt: new Date().toISOString() },
                    { id: 2, name: 'Carlos', lastName: 'L√≥pez Rodr√≠guez', dni: '87654321B', position: 'Conserje', status: 'Activo', accessCode: '5678', workingHours: 8, createdAt: new Date().toISOString() },
                    { id: 3, name: 'Mar√≠a', lastName: 'Fern√°ndez Silva', dni: '11223344C', position: 'Limpieza', status: 'Activo', accessCode: '9012', workingHours: 6, createdAt: new Date().toISOString() },
                    { id: 4, name: 'David', lastName: 'Ruiz Moreno', dni: '55667788D', position: 'Mantenimiento', status: 'Activo', accessCode: '3456', workingHours: 8, createdAt: new Date().toISOString() }
                ];
            },
            
            getTimeRecords() {
                const storedRecords = localStorage.getItem('fichajemax_timeRecords');
                if (storedRecords && storedRecords !== 'undefined') {
                    try { return JSON.parse(storedRecords); } catch (e) { return []; }
                }
                return [];
            },
            
            setTimeRecords(newRecords) {
                localStorage.setItem('fichajemax_timeRecords', JSON.stringify(newRecords));
                timeRecords = newRecords;
                refRegistros.set(newRecords).catch(error => console.error("Error al sincronizar registros:", error));
            },

            setGlobalConfig(configName, data) {
                localStorage.setItem(`fichajemax_${configName}`, JSON.stringify(data));
                refConfig.child(configName).set(data).catch(error => console.error(`Error sincronizando ${configName}:`, error));
            }
        };

        const ConfigManager = {
            getCompanySettings() {
                const storedSettings = localStorage.getItem('fichajemax_companySettings');
                if (storedSettings && storedSettings !== 'undefined') {
                    try { return JSON.parse(storedSettings); } catch (e) { return { companyName: 'Happy Hostal Carrales', companyCIF: 'B09539271', companyAddress: 'Calle Puente Gasset 4¬∫ 1¬∫ drch', companyPhone: '947263547' }; }
                }
                return { companyName: 'Happy Hostal Carrales', companyCIF: 'B09539271', companyAddress: 'Calle Puente Gasset 4¬∫ 1¬∫ drch', companyPhone: '947263547' };
            },
            setCompanySettings(settings) { DataManager.setGlobalConfig('companySettings', settings); },
            
            getLocationSettings() {
                const storedSettings = localStorage.getItem('fichajemax_locationSettings');
                if (storedSettings && storedSettings !== 'undefined') {
                    try { return JSON.parse(storedSettings); } catch (e) { return { enabled: true, workLatitude: 42.341646, workLongitude: -3.694808, allowedRadius: 10, workAddress: 'Happy Hostal Carrales - Calle Puente Gasset 4¬∫ 1¬∫ drch' }; }
                }
                return { enabled: true, workLatitude: 42.341646, workLongitude: -3.694808, allowedRadius: 10, workAddress: 'Happy Hostal Carrales - Calle Puente Gasset 4¬∫ 1¬∫ drch' };
            },
            setLocationSettings(settings) { DataManager.setGlobalConfig('locationSettings', settings); },
            
            getCloudSettings() { return { enabled: true, isFirebase: true, lastSync: new Date().toISOString() }; },
            setCloudSettings(settings) { /* No hace nada */ }
        };
        
        // Asignar datos iniciales
        employees = DataManager.getEmployees();
        timeRecords = DataManager.getTimeRecords();
        companySettings = ConfigManager.getCompanySettings();
        locationSettings = ConfigManager.getLocationSettings();
        adminCredentials = DataManager.getAdminCredentials();
        
        // Funciones de control de flujo

        function startRealtimeListeners() {
            refEmpleados.on('value', (snapshot) => {
                const firebaseEmployees = snapshot.val();
                if (firebaseEmployees) {
                    employees = firebaseEmployees;
                    localStorage.setItem('fichajemax_employees', JSON.stringify(employees));
                    if (currentUser) { loadEmployees(); populateSelects(); loadDashboard(); }
                    document.getElementById('syncIndicator')?.textContent = '‚òÅÔ∏è Sincronizado (Firebase)';
                }
            });
            refRegistros.on('value', (snapshot) => {
                const firebaseRecords = snapshot.val();
                if (firebaseRecords) {
                    timeRecords = firebaseRecords;
                    localStorage.setItem('fichajemax_timeRecords', JSON.stringify(timeRecords));
                    if (currentUser) { loadTimeRecords(); loadDashboard(); }
                }
            });
            refConfig.on('value', (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    if (JSON.stringify(config.companySettings) !== JSON.stringify(companySettings)) {
                        companySettings = config.companySettings || companySettings;
                        localStorage.setItem('fichajemax_companySettings', JSON.stringify(companySettings));
                        loadCompanySettings();
                    }
                    if (JSON.stringify(config.locationSettings) !== JSON.stringify(locationSettings)) {
                        locationSettings = config.locationSettings || locationSettings;
                        localStorage.setItem('fichajemax_locationSettings', JSON.stringify(locationSettings));
                        loadLocationSettings();
                    }
                }
            });
        }
        
        function setupEventListeners() {
            // Se a√±aden comprobaciones de existencia para evitar el ReferenceError
            if (document.getElementById('adminBtn')) document.getElementById('adminBtn').addEventListener('click', () => selectUserType('admin'));
            if (document.getElementById('employeeBtn')) document.getElementById('employeeBtn').addEventListener('click', () => selectUserType('employee'));
            if (document.getElementById('loginButton')) document.getElementById('loginButton').addEventListener('click', handleLogin);
            
            if (document.getElementById('adminPassword')) document.getElementById('adminPassword').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            if (document.getElementById('employeeCode')) document.getElementById('employeeCode').addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            if (document.getElementById('clockInBtn')) document.getElementById('clockInBtn').addEventListener('click', () => clockAction('in'));
            if (document.getElementById('clockOutBtn')) document.getElementById('clockOutBtn').addEventListener('click', () => clockAction('out'));
            
            if (document.getElementById('addEmployeeBtn')) document.getElementById('addEmployeeBtn').addEventListener('click', showEmployeeModal);
            if (document.getElementById('saveEmployee')) document.getElementById('saveEmployee').addEventListener('click', saveEmployee);
            if (document.getElementById('cancelEmployee')) document.getElementById('cancelEmployee').addEventListener('click', hideEmployeeModal);
            
            if (document.getElementById('addManualRecord')) document.getElementById('addManualRecord').addEventListener('click', showManualRecordModal);
            if (document.getElementById('saveManualRecord')) document.getElementById('saveManualRecord').addEventListener('click', saveManualRecord);
            if (document.getElementById('cancelManualRecord')) document.getElementById('cancelManualRecord').addEventListener('click', hideManualRecordModal);
            
            if (document.getElementById('saveEditRecord')) document.getElementById('saveEditRecord').addEventListener('click', saveEditRecord);
            if (document.getElementById('cancelEditRecord')) document.getElementById('cancelEditRecord').addEventListener('click', hideEditRecordModal);
            if (document.getElementById('deleteRecord')) document.getElementById('deleteRecord').addEventListener('click', deleteRecord);
            
            if (document.getElementById('generateReport')) document.getElementById('generateReport').addEventListener('click', generateReport);
            
            if (document.getElementById('applyFilters')) document.getElementById('applyFilters').addEventListener('click', applyFilters);
            
            if (document.getElementById('saveCompanySettings')) document.getElementById('saveCompanySettings').addEventListener('click', saveCompanySettingsForm);
            if (document.getElementById('saveAdminCredentials')) document.getElementById('saveAdminCredentials').addEventListener('click', saveAdminCredentialsForm);
            if (document.getElementById('saveLocationSettings')) document.getElementById('saveLocationSettings').addEventListener('click', saveLocationSettingsForm);
            if (document.getElementById('testCloudConnection')) document.getElementById('testCloudConnection').addEventListener('click', testCloudConnection);
            if (document.getElementById('syncNow')) document.getElementById('syncNow').addEventListener('click', syncNow);
            
            if (document.getElementById('getCurrentLocation')) document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocationForSetup);
            if (document.getElementById('testDistance')) document.getElementById('testDistance').addEventListener('click', testDistance);
            if (document.getElementById('refreshLocationBtn')) document.getElementById('refreshLocationBtn').addEventListener('click', refreshEmployeeLocation);
            
            if (document.getElementById('exportAllData')) document.getElementById('exportAllData').addEventListener('click', exportAllData);
            if (document.getElementById('exportRecords')) document.getElementById('exportRecords').addEventListener('click', exportRecords);
            
            if (document.getElementById('importDataFile')) document.getElementById('importDataFile').addEventListener('change', handleImportFile);
            if (document.getElementById('clearAllData')) document.getElementById('clearAllData').addEventListener('click', clearAllData);
            
            if (document.getElementById('helpBtn')) document.getElementById('helpBtn').addEventListener('click', showHelpModal);
            if (document.getElementById('closeHelp')) document.getElementById('closeHelp').addEventListener('click', hideHelpModal);
            if (document.getElementById('logoutBtn')) document.getElementById('logoutBtn').addEventListener('click', logout);
            
            if (document.getElementById('employeeWorkingHours')) document.getElementById('employeeWorkingHours').addEventListener('change', function() {
                const customContainer = document.getElementById('customHoursContainer');
                if (this.value === 'custom') {
                    if (customContainer) customContainer.classList.remove('hidden');
                    const customHoursInput = document.getElementById('employeeCustomHours');
                    if (customHoursInput) customHoursInput.focus();
                } else {
                    if (customContainer) customContainer.classList.add('hidden');
                }
            });
        }

        // Authentication & Session Logic

        function selectUserType(type) {
            selectedUserType = type;
            
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50');
                btn.classList.add('border-gray-200');
            });

            if (type === 'admin') {
                document.getElementById('adminBtn')?.classList.add('border-purple-500', 'bg-purple-50');
                document.getElementById('adminLogin')?.classList.remove('hidden');
                document.getElementById('employeeLogin')?.classList.add('hidden');
                setTimeout(() => { document.getElementById('adminPassword')?.focus(); }, 100);
            } else {
                document.getElementById('employeeBtn')?.classList.add('border-purple-500', 'bg-purple-50');
                document.getElementById('employeeLogin')?.classList.remove('hidden');
                document.getElementById('adminLogin')?.classList.add('hidden');
                setTimeout(() => { document.getElementById('employeeCode')?.focus(); }, 100);
            }
        }

        function handleLogin() {
            if (!selectedUserType) { UI.showNotification('‚ö†Ô∏è Seleccione un tipo de usuario', 'warning'); return; }
            
            if (selectedUserType === 'admin') {
                const password = document.getElementById('adminPassword')?.value.trim();
                
                if (password === adminCredentials.password) {
                    // CONTRASENA NORMAL (Octubre2012) -> MODO VISUALIZACI√ìN/AUDITOR√çA
                    isEditModeActive = false;
                    currentUser = { type: 'admin', name: adminCredentials.username };
                    showMainApp();
                    UI.showNotification(`‚úÖ Bienvenido ${adminCredentials.username}`, 'success');
                } else if (password === ADMIN_EDIT_PASSWORD) {
                    // CONTRASENA SECRETA (1010) -> MODO EDICI√ìN
                    isEditModeActive = true;
                    currentUser = { type: 'admin', name: adminCredentials.username + ' (Modo Edici√≥n)' };
                    showMainApp();
                    UI.showNotification(`‚úÖ Bienvenido ${adminCredentials.username} (Modo Edici√≥n)`, 'warning');
                } else {
                    UI.showNotification('‚ùå Contrase√±a incorrecta', 'error');
                }
            } else if (selectedUserType === 'employee') {
                const employeeCode = document.getElementById('employeeCode')?.value.trim();
                
                if (employeeCode) {
                    const employee = employees.find(emp => emp.accessCode === employeeCode && emp.status === 'Activo');
                    if (employee) {
                        isEditModeActive = false; 
                        currentUser = { type: 'employee', ...employee };
                        showMainApp();
                        UI.showNotification(`‚úÖ Bienvenido/a ${employee.name}`, 'success');
                    } else {
                        UI.showNotification('‚ùå C√≥digo incorrecto o empleado inactivo', 'error');
                        if (document.getElementById('employeeCode')) document.getElementById('employeeCode').value = '';
                    }
                } else {
                    UI.showNotification('üì± Ingrese su c√≥digo PIN', 'warning');
                }
            }
        }

        function showMainApp() {
            // CORRECCI√ìN CLAVE: Verificar si la sesi√≥n es v√°lida al intentar mostrar la APP
            if (!currentUser || !currentUser.type) {
                document.getElementById('loginScreen')?.classList.remove('hidden');
                document.getElementById('mainApp')?.classList.add('hidden');
                return;
            }
            
            document.getElementById('loginScreen')?.classList.add('hidden');
            document.getElementById('mainApp')?.classList.remove('hidden');
            
            if (currentUser.type === 'employee') { setupEmployeeInterface(); } else { setupAdminInterface(); }
            
            loadDashboard();
            loadEmployees();
            loadTimeRecords();
            loadStatistics();
            loadCompanySettings();
            loadAdminCredentialsForm();
            updateDataStatistics();
        }

        function setupEmployeeInterface() {
            document.querySelectorAll('.admin-only').forEach(element => { element.style.display = 'none'; });
            document.querySelectorAll('.employee-only').forEach(element => { element.style.display = 'block'; });

            const nameDisplay = document.getElementById('employeeNameDisplay');
            if (nameDisplay && currentUser) {
                nameDisplay.textContent = `${currentUser.name} ${currentUser.lastName}`;
                nameDisplay.classList.remove('hidden'); 
            }

            // CORRECCI√ìN: Asegura la visibilidad del bot√≥n de ubicaci√≥n
            const locationRefreshContainer = document.getElementById('locationRefreshContainer');
            const employeeLocationStatus = document.getElementById('employeeLocationStatus');
            if (locationRefreshContainer && locationSettings.enabled && currentUser?.type === 'employee') {
                locationRefreshContainer.classList.remove('hidden');
                if (employeeLocationStatus) employeeLocationStatus.classList.remove('hidden');
            } else {
                if (locationRefreshContainer) locationRefreshContainer.classList.add('hidden');
                if (employeeLocationStatus) employeeLocationStatus.classList.add('hidden');
            }
        }

        function setupAdminInterface() {
            document.querySelectorAll('.admin-only').forEach(element => { element.style.display = 'block'; });
            document.querySelectorAll('.employee-only').forEach(element => { element.style.display = 'none'; });
            document.getElementById('employeeNameDisplay')?.classList.add('hidden');
        }

        function logout() {
            console.log('Cerrando sesi√≥n y eliminando cach√© de sesi√≥n.');
            
            currentUser = null;
            selectedUserType = null;
            isEditModeActive = false;
            
            // 2. Limpiar datos residuales de la sesi√≥n en LocalStorage
            localStorage.removeItem('fichajemax_currentUser');
            localStorage.removeItem('fichajemax_selectedUserType');
            
            // 3. Forzar el estado de la interfaz (ocultar mainApp, mostrar login)
            document.getElementById('mainApp')?.classList.add('hidden');
            document.getElementById('loginScreen')?.classList.remove('hidden');
            
            // 4. Limpiar campos y botones
            if (document.getElementById('adminPassword')) document.getElementById('adminPassword').value = '';
            if (document.getElementById('employeeCode')) document.getElementById('employeeCode').value = '';
            document.getElementById('adminLogin')?.classList.add('hidden');
            document.getElementById('employeeLogin')?.classList.add('hidden');
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50');
                btn.classList.add('border-gray-200');
            });
            
            UI.showNotification('üëã Sesi√≥n cerrada y cach√© local limpiado.', 'success');
            
            // **CR√çTICO**: Forzar la recarga total para asegurar que no se restaure el estado bloqueado
            window.location.reload(true); 
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`)?.classList.add('active');
            
            document.getElementById('exportReportBtn')?.classList.add('hidden');
            
            switch(tabName) {
                case 'employees':
                    loadEmployees();
                    break;
                case 'records':
                    populateSelects(); 
                    loadTimeRecords();
                    break;
                case 'reports':
                    loadStatistics();
                    break;
                case 'settings':
                    loadCompanySettings();
                    loadAdminCredentialsForm();
                    loadLocationSettings();
                    loadCloudSettings();
                    break;
            }
        }

        function clockAction(type) {
            let employeeId;
            if (currentUser && currentUser.type === 'employee') {
                employeeId = currentUser.id;
            } else if (currentUser && currentUser.type === 'admin') {
                employeeId = document.getElementById('clockEmployeeSelect')?.value;
                if (!employeeId) {
                    UI.showNotification('üë§ Seleccione un empleado', 'warning');
                    return;
                }
            } else {
                 UI.showNotification('‚ö†Ô∏è Sesi√≥n de usuario no v√°lida.', 'error');
                 return;
            }
            performClockAction(employeeId, type);
        }

        async function performClockAction(employeeId, type) {
            // ... (L√≥gica de fichaje)
        }

        async function checkLocationPermission() {
            // ... (L√≥gica de ubicaci√≥n)
        }

        function getCurrentPosition() {
            // ... (L√≥gica de obtenci√≥n de posici√≥n)
        }

        function loadEmployees() {
            const gridElement = document.getElementById('employeesGrid');
            if (!gridElement) return;
            if (employees.length === 0) { gridElement.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No hay empleados registrados</p>'; return; }
            
            gridElement.innerHTML = employees.map(employee => {
                const lastRecord = timeRecords.filter(r => r.employeeId === employee.id).sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                const todayRecord = timeRecords.find(r => r.employeeId === employee.id && r.date === formatDate(new Date()));
                let statusBadge = '';
                if (employee.status === 'Activo' && todayRecord && todayRecord.timeIn && !todayRecord.timeOut) { statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 animate-pulse">üü¢ Trabajando</span>'; }
                else if (employee.status === 'Activo' && todayRecord && todayRecord.timeOut) { statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">üîµ Completado</span>'; }
                else if (employee.status === 'Activo') { statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">‚ö™ Sin fichar</span>'; }
                else { statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">‚ùå Inactivo</span>'; }
                
                const buttons = `
                    <button onclick="editEmployee(${employee.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-2 rounded-lg text-xs transition-colors">‚úèÔ∏è Editar</button>
                    <button onclick="toggleEmployeeStatus(${employee.id})" class="${employee.status === 'Activo' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white px-2 py-2 rounded-lg text-xs transition-colors">${employee.status === 'Activo' ? 'üö´ Desactivar' : '‚úÖ Activar'}</button>
                    <button onclick="deleteEmployee(${employee.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded-lg text-xs transition-colors">üóëÔ∏è Eliminar</button>
                `;

                return `
                    <div class="employee-card p-6">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold">${(employee.name[0] + employee.lastName[0]).toUpperCase()}</div>
                            <div class="flex-1"><h4 class="font-bold text-gray-800">${employee.name} ${employee.lastName}</h4><p class="text-sm text-gray-600">${employee.position || 'Sin especificar'}</p></div>
                            ${statusBadge}
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            <div class="flex justify-between"><span>üÜî DNI:</span><span class="font-mono">${employee.dni}</span></div>
                            <div class="flex justify-between"><span>üì± PIN:</span><span class="font-mono">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span></div>
                            <div class="flex justify-between"><span>‚è∞ Jornada:</span><span class="font-semibold">${employee.workingHours || 8}h/d√≠a</span></div>
                            ${lastRecord ? `<div class="flex justify-between"><span>üìÖ √öltimo:</span><span>${formatTimeAgo(lastRecord.date)}</span></div>` : ''}
                            ${todayRecord ? `<div class="flex justify-between"><span>‚è∞ Hoy:</span><span class="${todayRecord.totalHours >= (employee.workingHours || 8) ? 'text-green-600 font-bold' : 'text-orange-600'}">${todayRecord.totalHours?.toFixed(1) || '0.0'}h</span></div>` : ''}
                        </div>
                        <div class="grid grid-cols-3 gap-2">${buttons}</div>
                    </div>
                `;
            }).join('');
        }

        function loadTimeRecords() {
            const tableElement = document.getElementById('timeRecordsTable');
            if (!tableElement) return;

            let recordsToShow = (currentUser?.type === 'admin') ? filterRecords(timeRecords) : timeRecords.filter(r => r.employeeId === currentUser?.id);
            recordsToShow = recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));
            appState.lastRecordsData = recordsToShow;

            if (recordsToShow.length === 0) { tableElement.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay registros disponibles</td></tr>'; return; }
            
            tableElement.innerHTML = recordsToShow.map(record => {
                const statusClass = record.timeOut ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const totalHoursDisplay = record.totalHours ? formatHoursToHHMM(record.totalHours) : '00:00';
                const editButtonVisibilityClass = isEditModeActive ? 'visible' : '';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">${record.employeeName}</td>
                        <td class="px-6 py-4">${formatDateDisplay(record.date)}</td>
                        <td class="px-6 py-4 font-mono">${record.timeIn || '--:--'}</td>
                        <td class="px-6 py-4 font-mono">${record.timeOut || '--:--'}</td>
                        <td class="px-6 py-4 font-bold">${totalHoursDisplay}</td>
                        <td class="px-6 py-4"><span class="px-2 py-1 text-xs rounded-full ${statusClass}">${record.timeOut ? '‚úÖ Completo' : '‚è≥ En curso'}</span></td>
                        ${currentUser?.type === 'admin' ? `<td class="px-6 py-4"><button onclick="editRecord(${record.id})" class="text-blue-600 hover:text-blue-800 text-sm admin-edit-action ${editButtonVisibilityClass}">‚úèÔ∏è Editar</button></td>` : ''}
                    </tr>
                `;
            }).join('');
        }

        // Final Logic Execution

        function initializeData() {
            if (!localStorage.getItem('fichajemax_employees') || employees.length === 0) { DataManager.setEmployees(DataManager.getDefaultEmployees()); }
            if (!localStorage.getItem('fichajemax_companySettings')) { ConfigManager.setCompanySettings(companySettings); }
            if (!localStorage.getItem('fichajemax_adminCredentials')) { DataManager.setAdminCredentials(adminCredentials); }
            
            populateSelects();
            // ... (resto de inicializaci√≥n)
        }
        
        function App_initializer() {
            this.init = function() {
                // Llama a las funciones globales que ya est√°n definidas
                setupEventListeners();
                initializeData();
                startRealtimeListeners(); 
                // El resto de funciones se llama dentro de la l√≥gica de la app (loadDashboard, etc.)
                showMainApp(); 
            };
        }

        // CR√çTICO: Asegura que el punto de entrada principal se ejecute
        document.addEventListener('DOMContentLoaded', () => {
             new App_initializer().init();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9907ba73137aec95',t:'MTc2MDc4NzI4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
