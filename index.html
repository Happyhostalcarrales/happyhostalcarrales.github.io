<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Hostal Carrales - Sistema de Fichaje Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .gradient-bg {
            background: var(--primary-gradient);
        }
        
        .card-shadow {
            box-shadow: var(--shadow-md);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }
        
        .card-shadow:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: var(--primary-gradient);
            transition: var(--transition);
            border-radius: var(--border-radius);
            font-weight: 500;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: var(--success-gradient);
            transition: var(--transition);
            border-radius: var(--border-radius);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            transition: var(--transition);
            border-radius: var(--border-radius);
        }
        
        .time-display {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-weight: 600;
            letter-spacing: 0.05em;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-badge {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .scale-in {
            animation: scaleIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .clock-container {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.08),
                0 8px 16px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .employee-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            transition: var(--transition);
            border: 1px solid rgba(226, 232, 240, 0.8);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .employee-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            opacity: 0;
            transition: var(--transition);
        }
        
        .employee-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(102, 126, 234, 0.2);
        }
        
        .employee-card:hover::before {
            opacity: 1;
        }
        
        .nav-pill {
            border-radius: 20px;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
            cursor: pointer;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .nav-pill.active {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .nav-pill:not(.active) {
            background: rgba(243, 244, 246, 0.8);
            color: #6b7280;
            backdrop-filter: blur(10px);
        }
        
        .nav-pill:not(.active):hover {
            background: rgba(229, 231, 235, 0.9);
            transform: translateY(-1px);
        }
        
        .table-modern {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        
        .input-modern {
            border: 2px solid rgba(226, 232, 240, 0.8);
            border-radius: var(--border-radius);
            padding: 0.875rem 1rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            font-weight: 400;
        }
        
        .input-modern:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.08);
            outline: none;
            background: white;
        }
        
        .input-modern:hover:not(:focus) {
            border-color: rgba(102, 126, 234, 0.3);
        }
        
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-width: 420px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notification.success {
            background: var(--success-gradient);
        }
        
        .notification.error {
            background: var(--danger-gradient);
        }
        
        .notification.warning {
            background: var(--warning-gradient);
        }
        
        @keyframes slideInRight {
            from { 
                transform: translateX(100%) scale(0.9); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 520px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .loading-spinner {
            border: 3px solid rgba(243, 244, 246, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            text-align: center;
            transition: var(--transition);
            border: 1px solid rgba(226, 232, 240, 0.5);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        
        .sync-indicator {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--success-gradient);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            animation: pulse 3s ease-in-out infinite;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .sync-indicator.syncing {
            background: var(--warning-gradient);
            animation: pulse 1s ease-in-out infinite;
        }
        
        .sync-indicator.error {
            background: var(--danger-gradient);
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        
        .location-status {
            position: fixed;
            bottom: 80px;
            right: 24px;
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 500;
            z-index: 1000;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: var(--shadow-md);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .location-status.success {
            background: var(--success-gradient);
        }
        
        .location-status.error {
            background: var(--danger-gradient);
        }
        
        /* Ocultar acciones de edición solo si no están en modo edición */
        .admin-edit-action { 
            display: none !important; 
        }

        .admin-edit-action.visible { 
            display: inline-block !important;
        }
        
        /* ================================================= */
        /* MEJORAS DE DISEÑO RESPONSIVO (MOBILE FIRST)       */
        /* ================================================= */

        /* Dashboard y Empleados: Ajuste para que las columnas no se rompan demasiado */
        .employee-card .space-y-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        /* Encabezado: Compactar en móvil */
        header .flex {
            flex-wrap: wrap;
        }

        /* Tablet (md: 768px) */
        @media (min-width: 768px) {
            .employee-card .space-y-2 {
                display: block; /* Vuelve al diseño de pila en tablet para tener espacio */
            }

            /* Dashboard: Aumentar el tamaño de la fuente para el reloj en tablet */
            .clock-container #mainClock {
                font-size: 5rem;
            }

            /* Dashboard: 2 columnas en lugar de 4 en el resumen (opcional) */
            #todaySummary {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Desktop (lg: 1024px) */
        @media (min-width: 1024px) {
            /* Dashboard: Vuelve al diseño de 4 columnas en desktop */
            #todaySummary {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }

        /* Ajuste de Reloj para Móviles Pequeños */
        @media (max-width: 640px) {
            .clock-container #mainClock {
                font-size: 3rem; /* Tamaño más pequeño para móviles */
            }
        }
        
        /* Ajustes generales de posición */
        @media (max-width: 768px) {
            .sync-indicator,
            .location-status {
                right: 16px;
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
            
            .location-status {
                bottom: 70px;
            }
            
            .notification {
                right: 16px;
                top: 16px;
                max-width: calc(100vw - 32px);
            }

            /* Encabezado compacto en móvil */
            header .flex {
                padding-top: 1rem;
                padding-bottom: 1rem;
                flex-direction: column;
                align-items: flex-start;
            }
            
            header .flex > div:last-child {
                margin-top: 0.75rem;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            /* Ocultar la fecha en el encabezado para ahorrar espacio */
            header #currentDate {
                display: none;
            }

            /* Ajuste de padding en el contenedor principal */
            .max-w-7xl.mx-auto.px-4 {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            /* Forzar que el grid de empleados tenga una columna en móvil si el contenido es denso */
            #employeesGrid {
                 grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-full" style="overflow-x: hidden;">
    <div id="syncIndicator" class="sync-indicator">
        💾 Sistema Listo
    </div>

    <div id="locationStatusIndicator" class="location-status hidden">
        📍 Verificando ubicación...
    </div>

    <header class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-3 rounded-full">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">Horas Happy Hostal Carrales</h1>
                        <p class="text-sm opacity-90">Sistema de Fichaje con Control de Ubicación</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div id="currentTime" class="text-lg font-bold time-display"></div>
                        <div id="currentDate" class="text-sm opacity-90"></div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="helpBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-2 rounded-full transition-all" title="Ayuda y atajos de teclado">
                            ❓
                        </button>
                        <button id="logoutBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-full transition-all">
                            Salir
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="loginScreen" class="min-h-screen flex items-center justify-center py-12 px-4">
        <div class="max-w-md w-full">
            <div class="bg-white rounded-2xl card-shadow p-8 fade-in">
                <div class="text-center mb-8">
                    <div class="gradient-bg w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-900">Acceso al Sistema</h2>
                    <p class="text-gray-600 mt-2">Seleccione su tipo de usuario</p>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-3">Tipo de Usuario</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button type="button" id="adminBtn" class="user-type-btn p-4 border-2 border-gray-200 rounded-xl text-center hover:border-purple-500 transition-all">
                                <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                                </svg>
                                <div class="font-medium">Administrador</div>
                            </button>
                            <button type="button" id="employeeBtn" class="user-type-btn p-4 border-2 border-gray-200 rounded-xl text-center hover:border-purple-500 transition-all">
                                <svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"></path>
                                </svg>
                                <div class="font-medium">Empleado</div>
                            </button>
                        </div>
                    </div>

                    <div id="adminLogin" class="hidden">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Contraseña de Administrador</label>
                        <input type="password" id="adminPassword" class="input-modern w-full" placeholder="Ingrese su contraseña">
                    </div>

                    <div id="employeeLogin" class="hidden">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">📱 Código PIN</label>
                            <input type="password" id="employeeCode" class="input-modern w-full text-center text-2xl tracking-widest" placeholder="••••" maxlength="4">
                        </div>
                    </div>

                    <button id="loginButton" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                        🚀 Iniciar Sesión
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-2 py-4 overflow-x-auto">
                    <button class="nav-tab nav-pill active" data-tab="dashboard">
                        ⏰ Fichaje
                    </button>
                    <button class="nav-tab nav-pill admin-only" data-tab="employees">
                        👥 Empleados
                    </button>
                    <button class="nav-tab nav-pill" data-tab="records">
                        📋 Registros
                    </button>
                    <button class="nav-tab nav-pill admin-only" data-tab="reports">
                        📈 Informes
                    </button>
                    <button class="nav-tab nav-pill admin-only" data-tab="settings">
                        ⚙️ Configuración
                    </button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <div id="dashboardTab" class="tab-content active fade-in">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1">
                        <div class="clock-container text-center">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">🕐 Reloj de Fichaje</h3>
                            <div id="mainClock" class="text-4xl font-bold text-purple-600 mb-2 time-display"></div>
                            <div id="mainDate" class="text-gray-600 mb-6"></div>
                            
                            <div id="employeeLocationStatus" class="employee-only mb-4 p-3 rounded-xl bg-blue-50 border border-blue-200 hidden">
                                <div class="text-sm font-semibold text-blue-800 mb-1">📍 Estado de Ubicación:</div>
                                <div id="locationStatusText" class="text-sm text-blue-600">Verificando...</div>
                            </div>
                            
                            <div id="employeeStatus" class="employee-only mb-6 p-4 rounded-xl bg-gradient-to-r from-blue-50 to-purple-50" style="display: none;">
                                <div class="text-lg font-semibold mb-2">Estado Actual:</div>
                                <div id="currentStatus" class="text-2xl font-bold mb-2"></div>
                                <div id="statusTime" class="text-sm text-gray-600"></div>
                            </div>
                            
                            <div class="admin-only mb-4">
                                <select id="clockEmployeeSelect" class="input-modern w-full">
                                    <option value="">Seleccionar empleado</option>
                                </select>
                            </div>
                            
                            <div id="locationRefreshContainer" class="employee-only mb-4 hidden">
                                <button id="refreshLocationBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-xl transition-colors">
                                    📍 Actualizar Ubicación
                                </button>
                            </div>

                            <div id="employeeNameDisplay" class="employee-only text-4xl font-extrabold text-purple-700 mb-6 hidden">
                                </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="clockInBtn" class="btn-success text-white font-bold py-4 px-6 rounded-xl">
                                    ✅ ENTRADA
                                </button>
                                <button id="clockOutBtn" class="btn-danger text-white font-bold py-4 px-6 rounded-xl">
                                    🏁 SALIDA
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-2xl card-shadow p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">📊 Resumen de Hoy</h3>
                            <div id="todaySummary" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                </div>
                        </div>
                        
                        <div id="workingHoursProgress" class="employee-only mt-6 bg-white rounded-2xl card-shadow p-6 hidden">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">⏰ Progreso de Jornada</h3>
                            <div id="progressContent">
                                </div>
                        </div>
                        
                        <div class="mt-6 bg-white rounded-2xl card-shadow p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-6">🔄 Actividad Reciente</h3>
                            <div id="recentActivity" class="space-y-3">
                                </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="employeesTab" class="tab-content">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">👥 Gestión de Empleados</h3>
                        <button id="addEmployeeBtn" class="btn-primary text-white px-4 py-2 rounded-lg">
                            ➕ Nuevo Empleado
                        </button>
                    </div>

                    <div id="employeesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        </div>
                </div>
            </div>

            <div id="recordsTab" class="tab-content">
                <div class="bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">📋 Registros de Fichaje</h3>
                        <div class="flex space-x-2">
                            
                            <button id="addManualRecord" class="btn-primary text-white px-4 py-2 rounded-lg admin-only">
                                ➕ Registro Manual
                            </button>
                            <button id="exportRecords" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors admin-only">
                                📊 Exportar
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 admin-only">
                        <select id="filterEmployee" class="input-modern">
                            <option value="">Todos los empleados</option>
                        </select>
                        <input type="date" id="filterStartDate" class="input-modern">
                        <input type="date" id="filterEndDate" class="input-modern">
                        <button id="applyFilters" class="btn-primary text-white px-4 py-2 rounded-lg">
                            🔍 Filtrar
                        </button>
                    </div>

                    <div class="table-modern overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="gradient-bg text-white">
                                    <tr>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">👤 Empleado</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">📅 Fecha</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">🕐 Entrada</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">🕕 Salida</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">⏱️ Total</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold">📊 Estado</th>
                                        <th class="px-6 py-4 text-left text-sm font-semibold admin-only">⚙️ Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="timeRecordsTable" class="divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsTab" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">📊 Generador de Informes</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Empleado</label>
                                <select id="reportEmployee" class="input-modern w-full">
                                    <option value="">Todos los empleados</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">📅 Fecha Inicio</label>
                                    <input type="date" id="reportStartDate" class="input-modern w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">📅 Fecha Fin</label>
                                    <input type="date" id="reportEndDate" class="input-modern w-full">
                                </div>
                            </div>
                            <button id="generateReport" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                🚀 Generar Informe
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">📈 Estadísticas</h3>
                        <div id="statisticsContainer" class="space-y-4">
                            </div>
                    </div>
                </div>

                <div class="mt-8 bg-white rounded-2xl card-shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-800">📋 Resultados del Informe</h3>
                        
                        <button id="exportReportBtn" onclick="exportReportData()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors admin-only hidden">
                            📊 Exportar Informe
                        </button>
                    </div>
                    <div id="reportResults">
                        <p class="text-gray-500 text-center py-12">📊 Genere un informe para ver los resultados aquí</p>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="space-y-8">
                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">🏢 Configuración de la Empresa</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">🏢 Nombre de la Empresa</label>
                                <input type="text" id="companyName" class="input-modern w-full" value="Happy Hostal Carrales">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">🆔 CIF/NIF</label>
                                <input type="text" id="companyCIF" class="input-modern w-full" value="B12345678">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">📍 Dirección</label>
                                <input type="text" id="companyAddress" class="input-modern w-full" value="Calle Ejemplo, 123, 28001 Madrid">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">📞 Teléfono</label>
                                <input type="text" id="companyPhone" class="input-modern w-full" value="+34 912 345 678">
                            </div>
                        </div>
                        
                        <button id="saveCompanySettings" class="mt-6 btn-primary text-white px-6 py-2 rounded-lg">
                            💾 Guardar Configuración
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">🔐 Credenciales de Administrador</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Nombre de Usuario</label>
                                <input type="text" id="adminUsername" class="input-modern w-full" value="admin">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">🔒 Contraseña Actual</label>
                                <input type="password" id="currentAdminPassword" class="input-modern w-full" placeholder="Contraseña actual">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">🔑 Nueva Contraseña</label>
                                <input type="password" id="newAdminPassword" class="input-modern w-full" placeholder="Nueva contraseña">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">🔑 Confirmar Contraseña</label>
                                <input type="password" id="confirmAdminPassword" class="input-modern w-full" placeholder="Confirmar nueva contraseña">
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <p class="text-sm text-yellow-800">
                                <strong>⚠️ Importante:</strong> Guarde sus nuevas credenciales en un lugar seguro. Si las olvida, no podrá acceder como administrador.
                            </p>
                        </div>
                        
                        <button id="saveAdminCredentials" class="mt-6 btn-primary text-white px-6 py-2 rounded-lg">
                            🔐 Actualizar Credenciales
                        </button>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">📍 Control de Ubicación</h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">ℹ️ Información</h4>
                                <p class="text-sm text-blue-700 mb-2">
                                    El control de ubicación permite que los empleados solo puedan fichar cuando estén físicamente en el lugar de trabajo.
                                </p>
                                <ul class="text-xs text-blue-600 space-y-1 ml-4">
                                    <li>• Los administradores pueden fichar desde cualquier ubicación</li>
                                    <li>• Los empleados necesitan estar dentro del radio configurado</li>
                                    <li>• Se requieren permisos de ubicación en el navegador</li>
                                </ul>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="enableLocationControl" class="rounded">
                                    <span class="text-sm font-semibold">Activar Control de Ubicación para Empleados</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">📍 Dirección del Trabajo</label>
                                <input type="text" id="workAddress" class="input-modern w-full" placeholder="Dirección del lugar de trabajo">
                                <p class="text-xs text-gray-500 mt-1">Descripción opcional del lugar de trabajo</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">🌍 Latitud del Trabajo</label>
                                    <input type="number" id="workLatitude" class="input-modern w-full" step="0.000001" placeholder="40.416775">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">🌍 Longitud del Trabajo</label>
                                    <input type="number" id="workLongitude" class="input-modern w-full" step="0.000001" placeholder="-3.703790">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">📏 Radio Permitido: <span id="radiusValue">100</span> metros</label>
                                <input type="range" id="allowedRadius" class="w-full" min="10" max="500" value="100" oninput="document.getElementById('radiusValue').textContent = this.value">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>10m (muy estricto)</span>
                                    <span>500m (flexible)</span>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <button id="getCurrentLocation" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    📍 Obtener Ubicación Actual
                                </button>
                                <button id="testDistance" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    🎯 Probar Distancia
                                </button>
                                <button id="saveLocationSettings" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">
                                    💾 Guardar Configuración
                                </button>
                            </div>
                            
                            <div id="locationStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600 hidden">
                                Pruebe la distancia para ver el estado
                            </div>
                            
                            <div id="locationControlStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600">
                                Estado: Control desactivado
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">☁️ Sincronización en la Nube (Firebase)</h3>
                        
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <h4 class="font-bold text-blue-800 mb-2">ℹ️ Información</h4>
                                <p class="text-sm text-blue-700 mb-2">
                                    **La sincronización de fichaje usa Firebase Realtime Database para la función en tiempo real.**
                                </p>
                                <ul class="text-xs text-blue-600 space-y-1 ml-4">
                                    <li>• El sistema de sincronización es **instantáneo** y guarda los datos de forma persistente.</li>
                                    <li>• La configuración de JSONBin.io de abajo ya no tiene efecto y está deshabilitada.</li>
                                </ul>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">🔑 API Key de JSONBin.io</label>
                                    <input type="password" id="cloudApiKey" class="input-modern w-full" placeholder="Ingrese su API Key" disabled>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">🆔 Bin ID</label>
                                    <input type="text" id="cloudBinId" class="input-modern w-full" placeholder="ID del bin de datos" disabled>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-4">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="enableAutoSync" class="rounded" checked disabled>
                                    <span class="text-sm font-semibold">Sincronización Automática (Siempre activa con Firebase)</span>
                                </label>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">⏱️ Intervalo de Sincronización: <span id="syncIntervalValue">Tiempo Real</span></label>
                                <input type="range" id="syncInterval" class="w-full" min="1" max="60" value="5" disabled>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <button id="testCloudConnection" onclick="testCloudConnection()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    🔗 Probar Conexión
                                </button>
                                <button id="syncNow" onclick="syncNow()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors text-sm">
                                    ☁️ Forzar Guardado
                                </button>
                                <button id="saveCloudSettings" class="btn-primary text-white px-4 py-2 rounded-lg text-sm" disabled>
                                    💾 Guardar Configuración
                                </button>
                            </div>
                            
                            <div id="cloudStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600 hidden">
                                Pruebe la conexión para ver el estado
                            </div>
                            
                            <div id="cloudSyncStatus" class="p-3 rounded-lg bg-gray-100 text-sm text-gray-600">
                                Estado: Sincronización desactivada
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl card-shadow p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-6">💾 Gestión de Datos</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="exportAllData" class="bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg text-center transition-colors">
                                <div class="text-lg">📁</div>
                                <div class="text-sm">Exportar Todo</div>
                            </button>
                            
                            <label for="importDataFile" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-3 rounded-lg text-center cursor-pointer transition-colors">
                                <div class="text-lg">📂</div>
                                <div class="text-sm">Importar Datos</div>
                                <input type="file" id="importDataFile" class="hidden" accept=".json">
                            </label>
                            
                            <button id="clearAllData" class="bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg text-center transition-colors">
                                <div class="text-lg">🗑️</div>
                                <div class="text-sm">Limpiar Todo</div>
                            </button>
                        </div>
                        
                        <div id="dataStatistics" class="mt-6 p-4 bg-gray-50 rounded-xl">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="employeeModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">👤 Nuevo Empleado</h3>
            </div>
            <div class="p-6 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Nombre *</label>
                        <input type="text" id="employeeName" class="input-modern w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Apellidos *</label>
                        <input type="text" id="employeeLastName" class="input-modern w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">🆔 DNI/NIE/Pasaporte *</label>
                        <input type="text" id="employeeDNI" class="input-modern w-full" placeholder="12345678A / Y1234567Z / Pasaporte" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">💼 Puesto</label>
                        <input type="text" id="employeePosition" class="input-modern w-full">
                    </div>
                </div>

                <div class="border-t pt-4">
                    <h4 class="font-bold text-gray-800 mb-3">⏰ Horario y Jornada</h4>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">⏰ Jornada Estándar (Horas/día)</label>
                            <select id="employeeWorkingHours" class="input-modern w-full">
                                <option value="8">8 horas (Completa)</option>
                                <option value="7">7 horas</option>
                                <option value="6">6 horas</option>
                                <option value="5">5 horas</option>
                                <option value="4">4 horas (Media jornada)</option>
                                <option value="3">3 horas</option>
                                <option value="2">2 horas</option>
                                <option value="custom">Personalizada</option>
                            </select>
                        </div>
                        <div id="customHoursContainer" class="hidden">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">🕐 Horas Personalizadas</label>
                            <input type="number" id="employeeCustomHours" class="input-modern w-full" min="0.5" max="12" step="0.5" placeholder="Ej: 6.5">
                        </div>
                    </div>

                    <div id="employeeScheduleContainer" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                        </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">📱 Código PIN *</label>
                    <div class="flex space-x-2">
                        <input type="text" id="employeeAccessCode" class="input-modern flex-1 text-center text-lg tracking-widest" placeholder="1234" maxlength="4" pattern="[0-9]{4}" required>
                        <button type="button" onclick="document.getElementById('employeeAccessCode').value = generateRandomPIN(); UI.showNotification('🎲 PIN generado automáticamente', 'success');" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-2 rounded-lg text-sm transition-colors">
                            🎲 Auto
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Código de 4 dígitos para el empleado</p>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button id="cancelEmployee" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ❌ Cancelar
                </button>
                <button id="saveEmployee" class="btn-primary text-white px-6 py-2 rounded-lg">
                    💾 Guardar
                </button>
            </div>
        </div>
    </div>

    <div id="manualRecordModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">✏️ Registro Manual</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Empleado *</label>
                    <select id="manualRecordEmployee" class="input-modern w-full" required>
                        <option value="">Seleccionar empleado</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">📅 Fecha de Inicio *</label>
                        <input type="date" id="manualRecordDate" class="input-modern w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">📅 Fecha de Fin (Incluida)</label>
                        <input type="date" id="manualRecordEndDate" class="input-modern w-full">
                        <p class="text-xs text-gray-500 mt-1">Opcional. Registra el mismo horario en todo el rango.</p>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">🕐 Hora de Entrada</label>
                    <input type="time" id="manualRecordTimeIn" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">🕕 Hora de Salida</label>
                    <input type="time" id="manualRecordTimeOut" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">📝 Notas</label>
                    <textarea id="manualRecordNotes" class="input-modern w-full" rows="3" placeholder="Motivo del registro manual..."></textarea>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button id="cancelManualRecord" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ❌ Cancelar
                </button>
                <button id="saveManualRecord" class="btn-primary text-white px-6 py-2 rounded-lg">
                    💾 Guardar Registro(s)
                </button>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">❓ Ayuda y Atajos de Teclado</h3>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <h4 class="font-bold text-gray-800 mb-3">⌨️ Atajos de Teclado</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>**Modo Edición** (PIN: 1010)</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Login Admin</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Nuevo empleado</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Ctrl + E</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Registro manual</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Ctrl + R</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Guardar datos</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Ctrl + S</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>Cerrar modales</span>
                            <kbd class="px-2 py-1 bg-gray-200 rounded text-xs">Escape</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                            <span>Fichar entrada (empleados)</span>
                            <kbd class="px-2 py-1 bg-green-200 rounded text-xs">F1</kbd>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-red-50 rounded">
                            <span>Fichar salida (empleados)</span>
                            <kbd class="px-2 py-1 bg-red-200 rounded text-xs">F2</kbd>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-800 mb-3">🔧 Funciones Principales</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-start space-x-2">
                            <span class="text-blue-500">•</span>
                            <span><strong>Fichaje:</strong> Los empleados pueden fichar entrada/salida con su PIN</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-green-500">•</span>
                            <span><strong>Control de ubicación:</strong> Verificación GPS opcional para empleados</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-purple-500">•</span>
                            <span><strong>Sincronización:</strong> Datos automáticamente sincronizados en la nube</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-orange-500">•</span>
                            <span><strong>Informes:</strong> Generación de reportes y estadísticas</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-red-500">•</span>
                            <span><strong>Seguridad:</strong> Auto-logout por inactividad (30 min)</span>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-gray-800 mb-3">💡 Consejos</h4>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-500">💡</span>
                            <span>Use el botón "Auto" para generar PINs únicos automáticamente</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-500">💡</span>
                            <span>Los datos se guardan automáticamente cada 2 minutos</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-500">💡</span>
                            <span>Puede acceder desde múltiples dispositivos con sincronización instantánea</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-500">💡</span>
                            <span>Los turnos nocturnos son soportados (máximo 16 horas)</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end">
                <button id="closeHelp" class="btn-primary text-white px-6 py-2 rounded-lg">
                    ✅ Entendido
                </button>
            </div>
        </div>
    </div>

    <div id="editRecordModal" class="modal-overlay hidden">
        <div class="modal-content slide-up">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-xl font-bold">✏️ Editar Registro</h3>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">👤 Empleado</label>
                    <input type="text" id="editRecordEmployeeName" class="input-modern w-full" readonly>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">📅 Fecha</label>
                    <input type="date" id="editRecordDate" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">🕐 Hora de Entrada</label>
                    <input type="time" id="editRecordTimeIn" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">🕕 Hora de Salida</label>
                    <input type="time" id="editRecordTimeOut" class="input-modern w-full">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">📝 Notas</label>
                    <textarea id="editRecordNotes" class="input-modern w-full" rows="3"></textarea>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end space-x-3">
                <button id="deleteRecord" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg transition-colors">
                    🗑️ Eliminar
                </button>
                <button id="cancelEditRecord" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                    ❌ Cancelar
                </button>
                <button id="saveEditRecord" class="btn-primary text-white px-6 py-2 rounded-lg">
                    💾 Actualizar
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // =========================================================================
        // CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
        // =========================================================================

        // TUS CREDENCIALES DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyA3D7fH6QpdG7mUSNhFfUzD6RWje8TpGEk",
            authDomain: "hostaldatossincro.firebaseapp.com",
            databaseURL: "https://hostaldatossincro-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "hostaldatossincro",
            storageBucket: "hostaldatossincro.firebasedatorage.app",
            messagingSenderId: "955112940193",
            appId: "1:955112940193:web:f30f52858c1e6c0ddc46e0"
        };

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);

        // Referencias a los nodos de la base de datos
        const db = firebase.database();
        const refEmpleados = db.ref('fichaje/employees');
        const refRegistros = db.ref('fichaje/timeRecords');
        const refConfig = db.ref('fichaje/config');


        // =========================================================================
        // LÓGICA DE PERSISTENCIA DEL SISTEMA DE FICHAJE (USA FIREBASE)
        // =========================================================================

        // Application State Management
        class AppState {
            constructor() {
                this.currentUser = null;
                this.selectedUserType = null;
                this.editingRecordId = null;
                this.editingEmployeeId = null;
                this.autoSaveTimer = null;
                this.lastActivity = Date.now();
                this.syncInProgress = false;
                this.locationMonitoringInterval = null;
                // Almacenar los resultados del último informe generado
                this.lastReportData = []; 
                // Almacenar los registros de la última tabla Records (para exportar)
                this.lastRecordsData = []; 
            }
            
            reset() {
                this.currentUser = null;
                this.selectedUserType = null;
                this.editingRecordId = null;
                this.editingEmployeeId = null;
                this.clearTimers();
            }
            
            clearTimers() {
                if (this.autoSaveTimer) {
                    clearInterval(this.autoSaveTimer);
                    this.autoSaveTimer = null;
                }
                if (this.locationMonitoringInterval) {
                    clearInterval(this.locationMonitoringInterval);
                    this.locationMonitoringInterval = null;
                }
            }
        }
        
        const appState = new AppState();
        
        // Data Storage con Firebase 
        const DataManager = {
            getAdminCredentials() {
                const storedCredentials = localStorage.getItem('fichajemax_adminCredentials');
                if (storedCredentials && storedCredentials !== 'undefined') {
                    try {
                        return JSON.parse(storedCredentials);
                    } catch (e) {
                         console.error("Error al parsear adminCredentials:", e);
                    }
                }
                return {
                    username: 'admin',
                    password: 'Octubre2012'
                };
            },
            
            setAdminCredentials(credentials) {
                localStorage.setItem('fichajemax_adminCredentials', JSON.stringify(credentials));
            },
            
            getEmployees() {
                const storedEmployees = localStorage.getItem('fichajemax_employees');
                if (storedEmployees && storedEmployees !== 'undefined') {
                    try {
                        return JSON.parse(storedEmployees);
                    } catch (e) {
                        console.error("Error al parsear employees:", e);
                    }
                }
                return this.getDefaultEmployees();
            },
            
            // MODIFICACIÓN CLAVE: Quitamos la actualización de la variable global (employees = newEmployees)
            // porque Firebase lo hará. Solo guardamos en local y sincronizamos a la nube.
            setEmployees(newEmployees) {
                // 1. Guardar localmente (como fallback/backup)
                localStorage.setItem('fichajemax_employees', JSON.stringify(newEmployees));

                // 2. Sincronizar con Firebase
                refEmpleados.set(newEmployees)
                    .catch(error => {
                        console.error("Error al sincronizar empleados en Firebase:", error);
                        UI.showNotification('❌ Error al sincronizar empleados con la nube', 'error');
                    });
            },
            
            getDefaultEmployees() {
                // Nuevo formato de jornada:
                // - schedule: Objeto con horarios de entrada/salida por día (Lunes a Domingo).
                // - daysOff: Array de días de la semana que libra (ej: ["Sábado", "Domingo"]).
                return [
                    {
                        id: 1,
                        name: 'Ana',
                        lastName: 'García Martínez',
                        dni: '12345678A',
                        position: 'Recepcionista',
                        status: 'Activo',
                        accessCode: '1234',
                        workingHours: 8, // Se mantiene para compatibilidad y cálculo rápido
                        schedule: {
                            Lunes: { timeIn: '09:00', timeOut: '17:00' },
                            Martes: { timeIn: '09:00', timeOut: '17:00' },
                            Miércoles: { timeIn: '09:00', timeOut: '17:00' },
                            Jueves: { timeIn: '09:00', timeOut: '17:00' },
                            Viernes: { timeIn: '09:00', timeOut: '17:00' },
                            Sábado: { timeIn: null, timeOut: null },
                            Domingo: { timeIn: null, timeOut: null }
                        },
                        daysOff: ["Sábado", "Domingo"],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Carlos',
                        lastName: 'López Rodríguez',
                        dni: '87654321B',
                        position: 'Conserje',
                        status: 'Activo',
                        accessCode: '5678',
                        workingHours: 8,
                        schedule: {
                            Lunes: { timeIn: '15:00', timeOut: '23:00' },
                            Martes: { timeIn: '15:00', timeOut: '23:00' },
                            Miércoles: { timeIn: '15:00', timeOut: '23:00' },
                            Jueves: { timeIn: null, timeOut: null },
                            Viernes: { timeIn: null, timeOut: null },
                            Sábado: { timeIn: '10:00', timeOut: '18:00' },
                            Domingo: { timeIn: '10:00', timeOut: '18:00' }
                        },
                        daysOff: ["Jueves", "Viernes"],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        name: 'María',
                        lastName: 'Fernández Silva',
                        dni: '11223344C',
                        position: 'Limpieza',
                        status: 'Activo',
                        accessCode: '9012',
                        workingHours: 6,
                        schedule: {
                            Lunes: { timeIn: '12:00', timeOut: '18:00' },
                            Martes: { timeIn: '12:00', timeOut: '18:00' },
                            Miércoles: { timeIn: '12:00', timeOut: '18:00' },
                            Jueves: { timeIn: '12:00', timeOut: '18:00' },
                            Viernes: { timeIn: '12:00', timeOut: '18:00' },
                            Sábado: { timeIn: '08:00', timeOut: '14:00' },
                            Domingo: { timeIn: null, timeOut: null }
                        },
                        daysOff: ["Domingo"],
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 4,
                        name: 'David',
                        lastName: 'Ruiz Moreno',
                        dni: '55667788D',
                        position: 'Mantenimiento',
                        status: 'Activo',
                        accessCode: '3456',
                        workingHours: 8,
                        schedule: {
                            Lunes: { timeIn: '08:00', timeOut: '16:00' },
                            Martes: { timeIn: '08:00', timeOut: '16:00' },
                            Miércoles: { timeIn: '08:00', timeOut: '16:00' },
                            Jueves: { timeIn: '08:00', timeOut: '16:00' },
                            Viernes: { timeIn: '08:00', timeOut: '16:00' },
                            Sábado: { timeIn: null, timeOut: null },
                            Domingo: { timeIn: null, timeOut: null }
                        },
                        daysOff: ["Sábado", "Domingo"],
                        createdAt: new Date().toISOString()
                    }
                ];
            },
            
            getTimeRecords() {
                const storedRecords = localStorage.getItem('fichajemax_timeRecords');
                if (storedRecords && storedRecords !== 'undefined') {
                    try {
                        return JSON.parse(storedRecords);
                    } catch (e) {
                        console.error("Error al parsear timeRecords:", e);
                    }
                }
                return [];
            },
            
            // MODIFICACIÓN CLAVE: Quitamos la actualización de la variable global (timeRecords = newRecords)
            // porque Firebase lo hará. Solo guardamos en local y sincronizamos a la nube.
            setTimeRecords(newRecords) {
                // 1. Guardar localmente (como fallback/backup)
                localStorage.setItem('fichajemax_timeRecords', JSON.stringify(newRecords));

                // 2. Sincronizar con Firebase
                refRegistros.set(newRecords)
                    .catch(error => {
                        console.error("Error al sincronizar registros en Firebase:", error);
                        UI.showNotification('❌ Error al sincronizar registros con la nube', 'error');
                    });
            },

            // Configuraciones (Se guardan en un nodo separado)
            setGlobalConfig(configName, data) {
                localStorage.setItem(`fichajemax_${configName}`, JSON.stringify(data));
                refConfig.child(configName).set(data)
                    .catch(error => {
                        console.error(`Error sincronizando ${configName}:`, error);
                    });
            }
        };

        // Global data references (se inicializan con la versión local/default)
        let employees = DataManager.getEmployees();
        let timeRecords = DataManager.getTimeRecords();
        
        // Global variables for application state
        let currentUser = null;
        let selectedUserType = null;
        let editingRecordId = null;
        let editingEmployeeId = null;
        let syncInProgress = false;
        let syncInterval = null;
        let lastActivity = Date.now();
        let autoSaveTimer = null;
        
        // VARIABLE CLAVE: Controla la visibilidad de los botones de edición de registros
        let isEditModeActive = false;
        const ADMIN_EDIT_PASSWORD = '1010'; // PIN de modo edición
        
        // Configuration Management
        const ConfigManager = {
            getCompanySettings() {
                const storedSettings = localStorage.getItem('fichajemax_companySettings');
                // Asegura que no se intente parsear 'undefined'
                if (storedSettings && storedSettings !== 'undefined') {
                    try {
                        return JSON.parse(storedSettings);
                    } catch (e) {
                        console.error("Error al parsear companySettings:", e);
                    }
                }
                return {
                    companyName: 'Happy Hostal Carrales',
                    companyCIF: 'B09539271',
                    companyAddress: 'Calle Puente Gasset 4º 1º drch',
                    companyPhone: '947263547'
                };
            },
            
            setCompanySettings(settings) {
                DataManager.setGlobalConfig('companySettings', settings);
            },
            
            getLocationSettings() {
                const storedSettings = localStorage.getItem('fichajemax_locationSettings');
                // Asegura que no se intente parsear 'undefined'
                if (storedSettings && storedSettings !== 'undefined') {
                    try {
                        return JSON.parse(storedSettings);
                    } catch (e) {
                        console.error("Error al parsear locationSettings:", e);
                    }
                }
                return {
                    enabled: true,
                    workLatitude: 42.341646,
                    workLongitude: -3.694808,
                    allowedRadius: 10,
                    workAddress: 'Happy Hostal Carrales - Calle Puente Gasset 4º 1º drch'
                };
            },
            
            setLocationSettings(settings) {
                DataManager.setGlobalConfig('locationSettings', settings);
            },
            
            getCloudSettings() {
                return { enabled: true, isFirebase: true, lastSync: new Date().toISOString() };
            },
            
            setCloudSettings(settings) {
                // No hace nada
            }
        };
        
        // Global configuration references
        let companySettings = ConfigManager.getCompanySettings();
        let locationSettings = ConfigManager.getLocationSettings();
        let cloudSettings = ConfigManager.getCloudSettings(); 
        let adminCredentials = DataManager.getAdminCredentials();
        
        
        // =========================================================================
        // FUNCIÓN CLAVE: ESCUCHADORES DE FIREBASE EN TIEMPO REAL (MODIFICADO)
        // =========================================================================

        function startRealtimeListeners() {
            console.log('🔗 Iniciando escuchadores de Firebase para Fichaje...');

            // Escuchador de Empleados
            refEmpleados.on('value', (snapshot) => {
                const firebaseEmployees = snapshot.val();
                
                if (firebaseEmployees) {
                    // CAMBIO CLAVE 1: Sobrescribir la variable global con los datos de Firebase
                    employees = firebaseEmployees;
                    localStorage.setItem('fichajemax_employees', JSON.stringify(employees)); // Guardar en local como caché
                    console.log('✅ Empleados sincronizados desde Firebase');
                    
                    if (currentUser) {
                        loadEmployees();
                        populateSelects();
                        loadDashboard();
                    }
                    UI.updateSyncIndicator('success');
                } else if (!localStorage.getItem('fichajemax_employees') || employees.length === 0) {
                    // Si no hay datos en Firebase y el array global está vacío (o no hay local), 
                    // se inicializa con el array por defecto y se sube a Firebase.
                    console.log('⚠️ No hay empleados en Firebase. Subiendo los empleados por defecto.');
                    DataManager.setEmployees(DataManager.getDefaultEmployees());
                }
            }, (error) => {
                console.error("Error en escuchador de Empleados:", error);
                UI.updateSyncIndicator('error');
            });

            // Escuchador de Registros
            refRegistros.on('value', (snapshot) => {
                const firebaseRecords = snapshot.val();
                if (firebaseRecords) {
                    // CAMBIO CLAVE 2: Sobrescribir la variable global con los datos de Firebase
                    timeRecords = firebaseRecords;
                    localStorage.setItem('fichajemax_timeRecords', JSON.stringify(timeRecords)); // Guardar en local como caché
                    console.log('✅ Registros sincronizados desde Firebase');
                    
                    if (currentUser) {
                        loadTimeRecords();
                        loadDashboard();
                    }
                    UI.updateSyncIndicator('success');
                } else if (!localStorage.getItem('fichajemax_timeRecords') || timeRecords.length === 0) {
                    console.log('⚠️ No hay registros en Firebase.');
                    // Si no hay registros en Firebase ni en el caché local, no hace nada (empieza vacío)
                }
            }, (error) => {
                console.error("Error en escuchador de Registros:", error);
                UI.updateSyncIndicator('error');
            });

            // Escuchador de Configuraciones 
            refConfig.on('value', (snapshot) => {
                const config = snapshot.val();
                if (config) {
                    if (JSON.stringify(config.companySettings) !== JSON.stringify(companySettings)) {
                        companySettings = config.companySettings || config.companySettings;
                        localStorage.setItem('fichajemax_companySettings', JSON.stringify(companySettings));
                        if (currentUser) loadCompanySettings();
                    }
                    if (JSON.stringify(config.locationSettings) !== JSON.stringify(locationSettings)) {
                        locationSettings = config.locationSettings || config.locationSettings;
                        localStorage.setItem('fichajemax_locationSettings', JSON.stringify(locationSettings));
                        if (currentUser) loadLocationSettings();
                    }
                }
            });
        }


        // UI Management
        const UI = {
            updateSyncIndicator(status) {
                const indicator = document.getElementById('syncIndicator');
                if (!indicator) return;
                
                indicator.className = `sync-indicator ${status}`;
                
                switch(status) {
                    case 'success':
                        indicator.textContent = '☁️ Sincronizado (Firebase)';
                        break;
                    case 'syncing':
                        indicator.innerHTML = '<div class="loading-spinner"></div> Sincronizando...';
                        break;
                    case 'error':
                        indicator.textContent = '❌ Error de Sync';
                        break;
                }
            },
            
            showNotification(message, type = 'success') {
                document.querySelectorAll('.notification').forEach(n => n.remove());
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 4000);
            },
            
            updateDateTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                const dateString = now.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                const timeElements = ['currentTime', 'mainClock'];
                const dateElements = ['currentDate', 'mainDate'];
                
                timeElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = timeString;
                });
                
                dateElements.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = dateString;
                });
            }
        };
        
        // Application Initialization
        class App {
            constructor() {
                this.init();
            }
            
            init() {
                console.log('🚀 Inicializando aplicación optimizada...');
                
                this.setupDateTime();
                this.setupEventListeners();
                this.initializeData();
                this.setupRealtimeSync(); 
                this.setupSecurity();
                this.setupKeyboardShortcuts();
                
                console.log('✅ Aplicación inicializada correctamente');
            }
            
            setupDateTime() {
                UI.updateDateTime();
                setInterval(UI.updateDateTime, 1000);
            }
            
            setupEventListeners() {
                setupEventListeners();
            }
            
            initializeData() {
                // NOTA: Se ha quitado la inicialización de employees aquí. Ahora la 
                // lógica de carga/inicialización de datos la manejan los escuchadores 
                // de Firebase en 'startRealtimeListeners' para asegurar la bidireccionalidad.
                
                if (!localStorage.getItem('fichajemax_adminCredentials')) {
                    DataManager.setAdminCredentials(adminCredentials);
                }
                
                this.populateSelects();
                this.setDefaultDates();
                this.loadSettings();
            }
            
            setupRealtimeSync() { 
                startRealtimeListeners();
            }
            
            setupSecurity() {
                setupActivityMonitoring();
            }
            
            setupKeyboardShortcuts() {
                setupKeyboardShortcuts();
            }
            
            populateSelects() {
                populateSelects();
            }
            
            setDefaultDates() {
                setDefaultDates();
            }
            
            loadSettings() {
                loadLocationSettings();
                loadCloudSettings();
            }
        }
        
        // Función de inicialización de datos para asegurar que las variables globales
        // se cargan desde el caché o los valores por defecto al inicio.
        function ensureInitialDataLoad() {
            employees = DataManager.getEmployees();
            timeRecords = DataManager.getTimeRecords();
            companySettings = ConfigManager.getCompanySettings();
            locationSettings = ConfigManager.getLocationSettings();
            adminCredentials = DataManager.getAdminCredentials();
        }
        
        ensureInitialDataLoad(); // Ejecutar antes de inicializar la app

        // Initialize when DOM is ready (Esta es la línea que soluciona el problema de "null" si el script se carga en el body)
        // La ejecución de App() está dentro de DOMContentLoaded para asegurar que todos los elementos HTML existen.
        document.addEventListener('DOMContentLoaded', () => new App());

        // Event Listeners
        function setupEventListeners() {
            console.log('Configurando event listeners...');
            
            document.getElementById('adminBtn').addEventListener('click', () => selectUserType('admin'));
            document.getElementById('employeeBtn').addEventListener('click', () => selectUserType('employee'));
            document.getElementById('loginButton').addEventListener('click', handleLogin);
            
            document.getElementById('adminPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            document.getElementById('employeeCode').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            document.getElementById('clockInBtn').addEventListener('click', () => clockAction('in'));
            document.getElementById('clockOutBtn').addEventListener('click', () => clockAction('out'));
            
            document.getElementById('addEmployeeBtn').addEventListener('click', showEmployeeModal);
            document.getElementById('saveEmployee').addEventListener('click', saveEmployee);
            document.getElementById('cancelEmployee').addEventListener('click', hideEmployeeModal);
            
            document.getElementById('employeeWorkingHours').addEventListener('change', function() {
                const customContainer = document.getElementById('customHoursContainer');
                if (this.value === 'custom') {
                    customContainer.classList.remove('hidden');
                    document.getElementById('employeeCustomHours').focus();
                } else {
                    customContainer.classList.add('hidden');
                }
            });
            
            document.getElementById('addManualRecord').addEventListener('click', showManualRecordModal);
            document.getElementById('saveManualRecord').addEventListener('click', saveManualRecord);
            document.getElementById('cancelManualRecord').addEventListener('click', hideManualRecordModal);
            
            document.getElementById('saveEditRecord').addEventListener('click', saveEditRecord);
            document.getElementById('cancelEditRecord').addEventListener('click', hideEditRecordModal);
            document.getElementById('deleteRecord').addEventListener('click', deleteRecord);
            
            document.getElementById('generateReport').addEventListener('click', generateReport);
            
            // CONEXIÓN DEL BOTÓN DE FILTROS AL GENERADOR DE TABLA
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            
            document.getElementById('saveCompanySettings').addEventListener('click', saveCompanySettingsForm);
            document.getElementById('saveAdminCredentials').addEventListener('click', saveAdminCredentialsForm);
            document.getElementById('saveLocationSettings').addEventListener('click', saveLocationSettingsForm);
            document.getElementById('testCloudConnection').addEventListener('click', testCloudConnection);
            document.getElementById('syncNow').addEventListener('click', syncNow);
            
            document.getElementById('getCurrentLocation').addEventListener('click', getCurrentLocationForSetup);
            document.getElementById('testDistance').addEventListener('click', testDistance);
            document.getElementById('refreshLocationBtn').addEventListener('click', refreshEmployeeLocation);
            
            document.getElementById('exportAllData').addEventListener('click', exportAllData);
            
            // CONEXIÓN DEL BOTÓN DE EXPORTAR REGISTROS
            document.getElementById('exportRecords').addEventListener('click', exportRecords);
            
            document.getElementById('importDataFile').addEventListener('change', handleImportFile);
            document.getElementById('clearAllData').addEventListener('click', clearAllData);
            
            document.getElementById('helpBtn').addEventListener('click', showHelpModal);
            document.getElementById('closeHelp').addEventListener('click', hideHelpModal);
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            console.log('Event listeners configurados');
        }

        // Authentication
        function selectUserType(type) {
            console.log('Seleccionando tipo de usuario:', type);
            appState.selectedUserType = type;
            selectedUserType = type;
            
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50');
                btn.classList.add('border-gray-200');
            });

            if (type === 'admin') {
                document.getElementById('adminBtn').classList.add('border-purple-500', 'bg-purple-50');
                document.getElementById('adminLogin').classList.remove('hidden');
                document.getElementById('employeeLogin').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('adminPassword').focus();
                }, 100);
            } else {
                document.getElementById('employeeBtn').classList.add('border-purple-500', 'bg-purple-50');
                document.getElementById('employeeLogin').classList.remove('hidden');
                document.getElementById('adminLogin').classList.add('hidden');
                setTimeout(() => {
                    document.getElementById('employeeCode').focus();
                }, 100);
            }
        }

        function handleLogin() {
            console.log('Intentando login como:', selectedUserType);
            
            if (!selectedUserType) {
                UI.showNotification('⚠️ Seleccione un tipo de usuario', 'warning');
                return;
            }
            
            if (selectedUserType === 'admin') {
                const password = document.getElementById('adminPassword').value.trim();
                
                if (password === adminCredentials.password) {
                    // CONTRASENA NORMAL (SIN EDICIÓN)
                    isEditModeActive = false;
                    currentUser = { type: 'admin', name: adminCredentials.username };
                    UI.showNotification(`✅ Bienvenido ${adminCredentials.username}`, 'success');
                    showMainApp();
                } else if (password === ADMIN_EDIT_PASSWORD) {
                    // CONTRASENA SECRETA (CON EDICIÓN)
                    isEditModeActive = true;
                    currentUser = { type: 'admin', name: adminCredentials.username + ' (Modo Edición)' };
                    UI.showNotification(`✅ Bienvenido ${adminCredentials.username} (Modo Edición)`, 'warning');
                    showMainApp();
                } else {
                    UI.showNotification('❌ Contraseña incorrecta', 'error');
                    console.log('Login fallido - contraseña incorrecta');
                }
            } else if (selectedUserType === 'employee') {
                const employeeCode = document.getElementById('employeeCode').value.trim();
                
                if (employeeCode) {
                    authenticateEmployee(employeeCode);
                } else {
                    UI.showNotification('📱 Ingrese su código PIN', 'warning');
                }
            }
        }

        function authenticateEmployee(code) {
            console.log('Autenticando empleado con código:', code);
            const employee = employees.find(emp => emp.accessCode === code && emp.status === 'Activo');
            if (employee) {
                isEditModeActive = false; 
                currentUser = { type: 'employee', ...employee };
                UI.showNotification(`✅ Bienvenido/a ${employee.name}`, 'success');
                showMainApp();
            } else {
                UI.showNotification('❌ Código incorrecto o empleado inactivo', 'error');
                document.getElementById('employeeCode').value = '';
            }
        }

        function showMainApp() {
            console.log('Mostrando aplicación principal para:', currentUser);

            // CORRECCIÓN CLAVE: Verificar si la sesión es válida al intentar mostrar la APP
            if (!currentUser || !currentUser.type) {
                console.warn('⚠️ Intento de acceder a mainApp sin usuario válido. Forzando pantalla de Login.');
                
                // Asegurar que la pantalla de login esté visible y la principal oculta
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                
                // Forzar el estado de la interfaz de login (limpiar campos)
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('employeeLogin').classList.add('hidden');
                document.getElementById('adminPassword').value = '';
                document.getElementById('employeeCode').value = '';
                return; // Detener la ejecución si no hay usuario válido
            }
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            if (currentUser.type === 'employee') {
                setupEmployeeInterface();
                if (locationSettings.enabled) {
                    startLocationMonitoring();
                }
            } else {
                setupAdminInterface();
            }
            
            loadDashboard();
            loadEmployees();
            loadTimeRecords();
            loadStatistics();
            loadCompanySettings();
            loadAdminCredentialsForm();
            updateDataStatistics();
        }

        function setupEmployeeInterface() {
            console.log('Configurando interfaz de empleado');
            document.querySelectorAll('.admin-only').forEach(element => {
                element.style.display = 'none';
            });
            
            document.querySelectorAll('.employee-only').forEach(element => {
                // Aseguramos que los elementos específicos del empleado se vean
                element.style.display = 'block';
            });

            // Mostrar el nombre del empleado en grande al entrar
            const nameDisplay = document.getElementById('employeeNameDisplay');
            if (nameDisplay && currentUser && currentUser.type === 'employee') {
                nameDisplay.textContent = `${currentUser.name} ${currentUser.lastName}`;
                nameDisplay.classList.remove('hidden'); 
            }

            // LÓGICA DE VISIBILIDAD DEL BOTÓN DE UBICACIÓN
            const locationRefreshContainer = document.getElementById('locationRefreshContainer');
            const employeeLocationStatus = document.getElementById('employeeLocationStatus');
            
            if (locationRefreshContainer && locationSettings.enabled && currentUser.type === 'employee') {
                locationRefreshContainer.classList.remove('hidden'); // Mostrar el botón
                if (employeeLocationStatus) {
                    employeeLocationStatus.classList.remove('hidden'); // Mostrar el indicador de estado
                }
            } else {
                locationRefreshContainer.classList.add('hidden');
                if (employeeLocationStatus) {
                    employeeLocationStatus.classList.add('hidden');
                }
            }
        }

        function setupAdminInterface() {
            console.log('Configurando interfaz de administrador');
            document.querySelectorAll('.admin-only').forEach(element => {
                element.style.display = 'block';
            });
            
            document.querySelectorAll('.employee-only').forEach(element => {
                element.style.display = 'none';
            });

            // Ocultar el nombre del empleado
            const nameDisplay = document.getElementById('employeeNameDisplay');
            if (nameDisplay) {
                nameDisplay.classList.add('hidden'); 
            }
        }

        function logout() {
            console.log('Cerrando sesión y eliminando caché de sesión.');
            
            // 1. Limpiar el estado de las variables globales
            currentUser = null;
            selectedUserType = null;
            isEditModeActive = false; // Resetear estado de edición
            stopLocationMonitoring();

            // 2. Limpiar datos residuales de la sesión en LocalStorage
            localStorage.removeItem('fichajemax_currentUser');
            localStorage.removeItem('fichajemax_selectedUserType');
            
            // 3. Forzar el estado de la interfaz (ocultar mainApp, mostrar login)
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            // 4. Limpiar campos y botones
            document.getElementById('adminPassword').value = '';
            document.getElementById('employeeCode').value = '';
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('employeeLogin').classList.add('hidden');
            document.querySelectorAll('.user-type-btn').forEach(btn => {
                btn.classList.remove('border-purple-500', 'bg-purple-50');
                btn.classList.add('border-gray-200');
            });
            
            UI.showNotification('👋 Sesión cerrada y caché local limpiado.', 'success');
            
            // 5. Forzar la recarga total para asegurar que no se restaure el estado antiguo de JS.
            window.location.reload(true); 
        }

        // Navigation
        function switchTab(tabName) {
            console.log('Cambiando a pestaña:', tabName);
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}Tab`).classList.add('active');
            
            // Ocultar botón de exportar informe al cambiar de pestaña
            document.getElementById('exportReportBtn').classList.add('hidden');
            
            switch(tabName) {
                case 'employees':
                    loadEmployees();
                    break;
                case 'records':
                    // **CORRECCIÓN 1: Recargar la lista de empleados para el filtro**
                    populateSelects(); 
                    loadTimeRecords();
                    break;
                case 'reports':
                    loadStatistics();
                    // Al generar informe, este se cargará y el botón se hará visible
                    break;
                case 'settings':
                    loadCompanySettings();
                    loadAdminCredentialsForm();
                    loadLocationSettings();
                    loadCloudSettings();
                    break;
            }
        }

        // Clock Functions
        function clockAction(type) {
            console.log('Acción de fichaje:', type);
            
            let employeeId;
            if (currentUser.type === 'employee') {
                employeeId = currentUser.id;
            } else {
                employeeId = document.getElementById('clockEmployeeSelect').value;
                if (!employeeId) {
                    UI.showNotification('👤 Seleccione un empleado', 'warning');
                    return;
                }
            }
            
            performClockAction(employeeId, type);
        }

        async function performClockAction(employeeId, type) {
            console.log('Realizando fichaje:', { employeeId, type });
            UI.updateSyncIndicator('syncing');
            
            const employee = employees.find(emp => emp.id == employeeId);
            if (!employee) {
                UI.showNotification('❌ Empleado no encontrado', 'error');
                UI.updateSyncIndicator('error');
                return;
            }

            if (currentUser.type === 'employee' && locationSettings.enabled) {
                const locationCheck = await checkLocationPermission();
                if (!locationCheck.allowed) {
                    UI.showNotification(locationCheck.message, 'error');
                    UI.updateSyncIndicator('error');
                    return;
                }
            }
            
            const now = new Date();
            const today = formatDate(now);
            const currentTime = now.toTimeString().slice(0, 5);
            
            let existingRecord = timeRecords.find(record => 
                record.employeeId == employeeId && record.date === today
            );

            if (type === 'in') {
                if (existingRecord && existingRecord.timeIn) {
                    UI.showNotification('⚠️ Ya hay un registro de entrada para hoy', 'warning');
                    UI.updateSyncIndicator('success');
                    return;
                }
                
                if (!existingRecord) {
                    existingRecord = {
                        id: Date.now(),
                        employeeId: parseInt(employeeId),
                        employeeName: employee.name + ' ' + employee.lastName,
                        date: today,
                        timeIn: currentTime,
                        timeOut: null,
                        totalHours: 0,
                        method: currentUser.type === 'employee' ? 'pin' : 'manual',
                        notes: `Entrada registrada vía ${currentUser.type === 'employee' ? 'PIN' : 'manual'}`,
                        location: currentUser.type === 'employee' && locationSettings.enabled ? 'Ubicación verificada ✓' : null
                    };
                    timeRecords.push(existingRecord);
                } else {
                    existingRecord.timeIn = currentTime;
                    if (currentUser.type === 'employee' && locationSettings.enabled) {
                        existingRecord.location = 'Ubicación verificada ✓';
                    }
                }
                
                const locationMsg = currentUser.type === 'employee' && locationSettings.enabled ? ' - Ubicación verificada ✓' : '';
                UI.showNotification(`✅ Entrada registrada: ${currentTime}${locationMsg}`, 'success');
            } else {
                if (!existingRecord || !existingRecord.timeIn) {
                    UI.showNotification('⚠️ No hay registro de entrada para hoy', 'warning');
                    UI.updateSyncIndicator('success');
                    return;
                }
                
                if (existingRecord.timeOut) {
                    UI.showNotification('⚠️ Ya hay un registro de salida para hoy', 'warning');
                    UI.updateSyncIndicator('success');
                    return;
                }
                
                existingRecord.timeOut = currentTime;
                existingRecord.totalHours = calculateHours(existingRecord.timeIn, currentTime);
                
                const locationMsg = currentUser.type === 'employee' && locationSettings.enabled ? ' - Ubicación verificada ✓' : '';
                UI.showNotification(`🏁 Salida registrada: ${currentTime}${locationMsg}`, 'success');
            }
            
            saveTimeRecords();
            loadDashboard();
            loadTimeRecords();
        }

        // Location Functions
        async function checkLocationPermission() {
            if (!locationSettings.enabled || !locationSettings.workLatitude || !locationSettings.workLongitude) {
                return { allowed: true, message: '' };
            }

            try {
                const position = await getCurrentPosition();
                const distance = calculateDistance(
                    position.coords.latitude,
                    position.coords.longitude,
                    locationSettings.workLatitude,
                    locationSettings.workLongitude
                );

                if (distance <= locationSettings.allowedRadius) {
                    return { 
                        allowed: true, 
                        message: `Ubicación verificada (${Math.round(distance)}m del trabajo)`,
                        distance: distance
                    };
                } else {
                    return { 
                        allowed: false, 
                        message: `❌ Fuera del área de trabajo. Distancia: ${Math.round(distance)}m (máximo: ${locationSettings.allowedRadius}m)`,
                        distance: distance
                    };
                }
            } catch (error) {
                console.error('Location error:', error);
                let errorMessage = '❌ Error al obtener ubicación.';
                
                if (error.code === 1) {
                    errorMessage = '❌ Permisos de ubicación denegados. Active el GPS y permita el acceso.';
                } else if (error.code === 2) {
                    errorMessage = '❌ Ubicación no disponible. Verifique su conexión GPS.';
                } else if (error.code === 3) {
                    errorMessage = '❌ Tiempo de espera agotado. Intente nuevamente.';
                }
                
                return { 
                    allowed: false, 
                    message: errorMessage 
                };
            }
        }

        function getCurrentPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject({ code: 0, message: 'Geolocalización no soportada en este dispositivo' });
                    return;
                }

                const options = {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 30000
                };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('Ubicación obtenida:', position.coords.latitude, position.coords.longitude);
                        resolve(position);
                    },
                    (error) => {
                        console.error('Error de geolocalización:', error);
                        reject(error);
                    },
                    options
                );
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = lat1 * Math.PI/180;
            const φ2 = lat2 * Math.PI/180;
            const Δφ = (lat2-lat1) * Math.PI/180;
            const Δλ = (lon2-lon1) * Math.PI/180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        async function getCurrentLocationForSetup() {
            const button = document.getElementById('getCurrentLocation');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<div class="loading-spinner"></div> Obteniendo...';
                button.disabled = true;
                
                UI.showNotification('📍 Obteniendo ubicación actual...', 'success');
                const position = await getCurrentPosition();
                
                document.getElementById('workLatitude').value = position.coords.latitude.toFixed(6);
                document.getElementById('workLongitude').value = position.coords.longitude.toFixed(6);
                
                UI.showNotification('✅ Ubicación capturada correctamente', 'success');
            } catch (error) {
                console.error('Error getting location:', error);
                let errorMessage = '❌ Error al obtener ubicación.';
                
                if (error.code === 1) {
                    errorMessage = '❌ Permisos de ubicación denegados. Active el GPS y permita el acceso en su navegador.';
                } else if (error.code === 2) {
                    errorMessage = '❌ Ubicación no disponible. Verifique que el GPS esté activado.';
                } else if (error.code === 3) {
                    errorMessage = '❌ Tiempo de espera agotado. Intente nuevamente.';
                }
                
                UI.showNotification(errorMessage, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        async function testDistance() {
            if (!locationSettings.enabled || !locationSettings.workLatitude || !locationSettings.workLongitude) {
                UI.showNotification('⚠️ Configure primero la ubicación del trabajo', 'warning');
                return;
            }

            const button = document.getElementById('testDistance');
            const originalText = button.innerHTML;

            try {
                button.innerHTML = '<div class="loading-spinner"></div> Verificando...';
                button.disabled = true;
                
                UI.showNotification('📍 Verificando distancia...', 'success');
                const position = await getCurrentPosition();
                const distance = calculateDistance(
                    position.coords.latitude,
                    position.coords.longitude,
                    locationSettings.workLatitude,
                    locationSettings.workLongitude
                );

                const isWithinRange = distance <= locationSettings.allowedRadius;
                const message = isWithinRange 
                    ? `✅ Dentro del área permitida: ${Math.round(distance)}m del trabajo`
                    : `❌ Fuera del área: ${Math.round(distance)}m (máximo permitido: ${locationSettings.allowedRadius}m)`;
                
                UI.showNotification(message, isWithinRange ? 'success' : 'warning');
                
                updateLocationStatus(isWithinRange, Math.round(distance));
                
            } catch (error) {
                console.error('Error testing distance:', error);
                let errorMessage = '❌ Error al verificar distancia.';
                
                if (error.code === 1) {
                    errorMessage = '❌ Permisos de ubicación denegados.';
                } else if (error.code === 2) {
                    errorMessage = '❌ Ubicación no disponible.';
                } else if (error.code === 3) {
                    errorMessage = '❌ Tiempo de espera agotado.';
                }
                
                UI.showNotification(errorMessage, 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        function updateLocationStatus(isWithinRange, distance) {
            const statusElement = document.getElementById('locationStatus');
            if (statusElement) {
                statusElement.classList.remove('hidden');
                if (isWithinRange) {
                    statusElement.innerHTML = `<span class="text-green-600">✅ En área de trabajo (${distance}m)</span>`;
                    statusElement.className = 'p-3 rounded-lg bg-green-100 text-sm';
                } else {
                    statusElement.innerHTML = `<span class="text-red-600">❌ Fuera del área (${distance}m)</span>`;
                    statusElement.className = 'p-3 rounded-lg bg-red-100 text-sm';
                }
            }
        }

        function saveLocationSettingsForm() {
            locationSettings.enabled = document.getElementById('enableLocationControl').checked;
            locationSettings.workLatitude = parseFloat(document.getElementById('workLatitude').value) || null;
            locationSettings.workLongitude = parseFloat(document.getElementById('workLongitude').value) || null;
            locationSettings.allowedRadius = parseInt(document.getElementById('allowedRadius').value) || 100;
            locationSettings.workAddress = document.getElementById('workAddress').value || '';
            
            ConfigManager.setLocationSettings(locationSettings); 
            UI.showNotification('📍 Configuración de ubicación guardada', 'success');
            
            updateLocationControlStatus();
        }

        function updateLocationControlStatus() {
            const statusElement = document.getElementById('locationControlStatus');
            if (!statusElement) return;
            
            if (locationSettings.enabled && locationSettings.workLatitude && locationSettings.workLongitude) {
                statusElement.innerHTML = `
                    <div class="text-green-700">
                        <strong>Estado:</strong> 📍 Control activo<br>
                        <strong>Ubicación:</strong> ${locationSettings.workAddress || 'Coordenadas configuradas'}<br>
                        <strong>Radio:</strong> ${locationSettings.allowedRadius}m
                    </div>
                `;
                statusElement.className = 'p-3 rounded-lg bg-green-100 text-sm';
            } else if (locationSettings.enabled) {
                statusElement.innerHTML = '<div class="text-yellow-700"><strong>Estado:</strong> ⚠️ Activado pero sin coordenadas</div>';
                statusElement.className = 'p-3 rounded-lg bg-yellow-100 text-sm';
            } else {
                statusElement.innerHTML = '<div class="text-gray-600"><strong>Estado:</strong> ❌ Control desactivado</div>';
                statusElement.className = 'p-3 rounded-lg bg-gray-100 text-sm';
            }
        }

        function loadLocationSettings() {
            document.getElementById('enableLocationControl').checked = locationSettings.enabled;
            document.getElementById('workLatitude').value = locationSettings.workLatitude || '';
            document.getElementById('workLongitude').value = locationSettings.workLongitude || '';
            document.getElementById('allowedRadius').value = locationSettings.allowedRadius || 100;
            document.getElementById('workAddress').value = locationSettings.workAddress || '';
            
            document.getElementById('radiusValue').textContent = locationSettings.allowedRadius || 100;
            
            updateLocationControlStatus();
        }

        // Location monitoring for employees
        let locationMonitoringInterval = null;

        function startLocationMonitoring() {
            if (!locationSettings.enabled || currentUser.type !== 'employee') return;
            
            const statusElement = document.getElementById('employeeLocationStatus');
            if (statusElement) {
                statusElement.classList.remove('hidden');
            }
            
            locationMonitoringInterval = setInterval(async () => {
                try {
                    const locationCheck = await checkLocationPermission();
                    updateEmployeeLocationStatus(locationCheck);
                } catch (error) {
                    console.error('Location monitoring error:', error);
                }
            }, 30000);
            
            setTimeout(async () => {
                try {
                    const locationCheck = await checkLocationPermission();
                    updateEmployeeLocationStatus(locationCheck);
                } catch (error) {
                    console.error('Initial location check error:', error);
                }
            }, 2000);
        }

        function stopLocationMonitoring() {
            if (locationMonitoringInterval) {
                clearInterval(locationMonitoringInterval);
                locationMonitoringInterval = null;
            }
            
            const statusElement = document.getElementById('employeeLocationStatus');
            if (statusElement) {
                statusElement.classList.add('hidden');
            }
        }

        function updateEmployeeLocationStatus(locationCheck) {
            const statusTextElement = document.getElementById('locationStatusText');
            const indicatorElement = document.getElementById('locationStatusIndicator');
            
            if (statusTextElement) {
                if (locationCheck.allowed) {
                    statusTextElement.innerHTML = `<span class="text-green-600">✅ En área de trabajo</span>`;
                    if (indicatorElement) {
                        indicatorElement.innerHTML = '📍 En área de trabajo';
                        indicatorElement.className = 'location-status success';
                        indicatorElement.classList.remove('hidden');
                    }
                } else {
                    statusTextElement.innerHTML = `<span class="text-red-600">❌ Fuera del área de trabajo</span>`;
                    if (indicatorElement) {
                        indicatorElement.innerHTML = '📍 Fuera del área';
                        indicatorElement.className = 'location-status error';
                        indicatorElement.classList.remove('hidden');
                    }
                }
            }
        }

        async function refreshEmployeeLocation() {
            if (!locationSettings.enabled || currentUser.type !== 'employee') return;
            
            const button = document.getElementById('refreshLocationBtn');
            const originalText = button.innerHTML;
            
            try {
                button.innerHTML = '<div class="loading-spinner"></div> Verificando...';
                button.disabled = true;
                
                UI.showNotification('📍 Actualizando ubicación...', 'success');
                const locationCheck = await checkLocationPermission();
                
                updateEmployeeLocationStatus(locationCheck);
                
                if (locationCheck.allowed) {
                    UI.showNotification(`✅ Ubicación actualizada - En área de trabajo (${Math.round(locationCheck.distance)}m)`, 'success');
                } else {
                    UI.showNotification(locationCheck.message, 'warning');
                }
                
            } catch (error) {
                console.error('Error refreshing location:', error);
                UI.showNotification('❌ Error al actualizar ubicación', 'error');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Data Loading Functions
        function loadDashboard() {
            console.log('Cargando dashboard');
            const today = formatDate(new Date());
            let todayRecords = timeRecords.filter(record => record.date === today);
            
            if (currentUser && currentUser.type === 'employee') {
                todayRecords = todayRecords.filter(record => record.employeeId === currentUser.id);
                updateEmployeeStatus(today);
            }
            
            const summaryElement = document.getElementById('todaySummary');
            if (summaryElement) {
                if (currentUser && currentUser.type === 'employee') {
                    const myRecord = todayRecords[0];
                    const myWeekRecords = timeRecords.filter(record => {
                        const recordDate = new Date(record.date);
                        const weekStart = new Date();
                        weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                        return record.employeeId === currentUser.id && recordDate >= weekStart;
                    });
                    const weekHours = myWeekRecords.reduce((sum, record) => sum + (record.totalHours || 0), 0);
                    
                    summaryElement.innerHTML = `
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-blue-600">⏰ ${myRecord?.timeIn || '--:--'}</div>
                            <div class="text-sm text-gray-600">Entrada</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-green-600">🏁 ${myRecord?.timeOut || '--:--'}</div>
                            <div class="text-sm text-gray-600">Salida</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-purple-600">📊 ${myRecord?.totalHours?.toFixed(1) || '0.0'}h</div>
                            <div class="text-sm text-gray-600">Horas Hoy</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-orange-600">📈 ${weekHours.toFixed(1)}h</div>
                            <div class="text-sm text-gray-600">Esta Semana</div>
                        </div>
                    `;
                } else {
                    const totalEmployees = employees.filter(emp => emp.status === 'Activo').length;
                    const presentEmployees = todayRecords.filter(record => record.timeIn && !record.timeOut).length;
                    const completedShifts = todayRecords.filter(record => record.timeOut).length;
                    const totalHours = todayRecords.reduce((sum, record) => sum + (record.totalHours || 0), 0);
                    
                    summaryElement.innerHTML = `
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-blue-600">👥 ${totalEmployees}</div>
                            <div class="text-sm text-gray-600">Empleados</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-green-600">✅ ${presentEmployees}</div>
                            <div class="text-sm text-gray-600">Trabajando</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-purple-600">🏁 ${completedShifts}</div>
                            <div class="text-sm text-gray-600">Completados</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-3xl font-bold text-orange-600">⏱️ ${totalHours.toFixed(1)}h</div>
                            <div class="text-sm text-gray-600">Total Horas</div>
                        </div>
                    `;
                }
            }
            
            loadRecentActivity();
        }

        function updateEmployeeStatus(today) {
            const statusElement = document.getElementById('currentStatus');
            const statusTimeElement = document.getElementById('statusTime');
            const employeeStatusElement = document.getElementById('employeeStatus');
            
            if (!statusElement || !currentUser || currentUser.type !== 'employee') return;
            
            const myRecord = timeRecords.find(record => 
                record.employeeId === currentUser.id && record.date === today
            );
            
            if (employeeStatusElement) {
                employeeStatusElement.style.display = 'block';
            }
            
            if (myRecord) {
                if (myRecord.timeIn && !myRecord.timeOut) {
                    statusElement.innerHTML = '<span class="text-green-600 status-badge">🟢 TRABAJANDO</span>';
                    statusTimeElement.textContent = `Entrada: ${myRecord.timeIn}`;
                } else if (myRecord.timeIn && myRecord.timeOut) {
                    statusElement.innerHTML = '<span class="text-blue-600">🔵 COMPLETADO</span>';
                    statusTimeElement.textContent = `${myRecord.timeIn} - ${myRecord.timeOut} (${myRecord.totalHours}h)`;
                } else {
                    statusElement.innerHTML = '<span class="text-gray-600">⚪ SIN FICHAR</span>';
                    statusTimeElement.textContent = 'No hay registros para hoy';
                }
            } else {
                statusElement.innerHTML = '<span class="text-gray-600">⚪ SIN FICHAR</span>';
                statusTimeElement.textContent = 'No hay registros para hoy';
            }
            
            updateWorkingHoursProgress(myRecord);
        }

        function updateWorkingHoursProgress(record) {
            const progressElement = document.getElementById('workingHoursProgress');
            const progressContent = document.getElementById('progressContent');
            
            if (!progressElement || !progressContent || !currentUser || currentUser.type !== 'employee') return;
            
            const employee = employees.find(emp => emp.id === currentUser.id);
            if (!employee) return;
            
            const expectedHours = employee.workingHours || 8;
            const workedHours = record?.totalHours || 0;
            const progressPercentage = Math.min((workedHours / expectedHours) * 100, 100);
            
            let statusColor = 'bg-red-500';
            let statusText = 'Pendiente';
            let statusIcon = '🔴';
            
            if (progressPercentage >= 100) {
                statusColor = 'bg-green-500';
                statusText = 'Jornada Completa';
                statusIcon = '✅';
            } else if (progressPercentage >= 75) {
                statusColor = 'bg-yellow-500';
                statusText = 'Casi Completa';
                statusIcon = '🟡';
            } else if (progressPercentage >= 25) {
                statusColor = 'bg-orange-500';
                statusText = 'En Progreso';
                statusIcon = '🟠';
            }
            
            progressContent.innerHTML = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-semibold text-gray-700">Horas Trabajadas</span>
                        <span class="text-sm font-bold">${workedHours.toFixed(1)}h / ${expectedHours}h</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="${statusColor} h-4 rounded-full transition-all duration-500" style="width: ${progressPercentage}%"></div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="text-lg font-bold text-gray-800">${expectedHours}h</div>
                        <div class="text-xs text-gray-600">Jornada</div>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <div class="text-lg font-bold text-blue-600">${workedHours.toFixed(1)}h</div>
                        <div class="text-xs text-gray-600">Trabajadas</div>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-lg">
                        <div class="text-lg font-bold text-purple-600">${Math.max(0, expectedHours - workedHours).toFixed(1)}h</div>
                        <div class="text-xs text-gray-600">Restantes</div>
                    </div>
                </div>
                
                <div class="mt-4 p-3 rounded-lg ${statusColor.replace('bg-', 'bg-').replace('-500', '-100')} border border-${statusColor.replace('bg-', '').replace('-500', '-200')}">
                    <div class="flex items-center justify-center space-x-2">
                        <span class="text-lg">${statusIcon}</span>
                        <span class="font-semibold text-${statusColor.replace('bg-', '').replace('-500', '-800')}">${statusText}</span>
                    </div>
                </div>
            `;
            
            progressElement.classList.remove('hidden');
        }

        function loadRecentActivity() {
            const activityElement = document.getElementById('recentActivity');
            if (!activityElement) return;
            
            let recentRecords;
            
            if (currentUser && currentUser.type === 'employee') {
                recentRecords = timeRecords
                    .filter(record => record.employeeId === currentUser.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
            } else {
                recentRecords = timeRecords
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 10);
            }
            
            if (recentRecords.length === 0) {
                activityElement.innerHTML = '<p class="text-gray-500 text-center py-8">No hay actividad reciente</p>';
                return;
            }
            
            activityElement.innerHTML = recentRecords.map(record => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                            <span class="text-purple-600 font-bold text-sm">
                                ${record.employeeName.split(' ').map(n => n[0]).join('').substring(0, 2)}
                            </span>
                        </div>
                        <div>
                            <div class="font-semibold">${record.employeeName}</div>
                            <div class="text-sm text-gray-600">${formatDateDisplay(record.date)}</div>
                            ${record.location ? `<div class="text-xs text-green-600">${record.location}</div>` : ''}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold">
                            ${record.timeIn || '--:--'} - ${record.timeOut || '--:--'}
                        </div>
                        <div class="text-sm text-gray-600">
                            ${record.totalHours?.toFixed(1) || '0.0'}h
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function loadEmployees() {
            console.log('Cargando empleados');
            const gridElement = document.getElementById('employeesGrid');
            if (!gridElement) return;
            
            if (employees.length === 0) {
                gridElement.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">No hay empleados registrados</p>';
                return;
            }
            
            gridElement.innerHTML = employees.map(employee => {
                const lastRecord = timeRecords
                    .filter(record => record.employeeId === employee.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                
                const today = formatDate(new Date());
                const todayRecord = timeRecords.find(record => 
                    record.employeeId === employee.id && record.date === today
                );
                
                let statusBadge = '';
                if (employee.status === 'Activo' && todayRecord) {
                    if (todayRecord.timeIn && !todayRecord.timeOut) {
                        statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 animate-pulse">🟢 Trabajando</span>';
                    } else if (todayRecord.timeOut) {
                        statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">🔵 Completado</span>';
                    }
                } else if (employee.status === 'Activo') {
                    statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800">⚪ Sin fichar</span>';
                } else {
                    statusBadge = '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">❌ Inactivo</span>';
                }
                
                return `
                    <div class="employee-card p-6">
                        <div class="flex items-center space-x-4 mb-4">
                            <div class="w-12 h-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                                ${(employee.name[0] + employee.lastName[0]).toUpperCase()}
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${employee.name} ${employee.lastName}</h4>
                                <p class="text-sm text-gray-600">${employee.position || 'Sin especificar'}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600 mb-4">
                            <div class="flex justify-between">
                                <span>🆔 Documento:</span>
                                <span class="font-mono">••••••••</span>
                            </div>
                            <div class="flex justify-between">
                                <span>📱 PIN:</span>
                                <span class="font-mono">••••</span>
                            </div>
                            <div class="flex justify-between">
                                <span>⏰ Jornada:</span>
                                <span class="font-semibold">${employee.workingHours || 8}h/día</span>
                            </div>
                            ${lastRecord ? `
                                <div class="flex justify-between">
                                    <span>📅 Último:</span>
                                    <span>${formatTimeAgo(lastRecord.date)}</span>
                                </div>
                            ` : ''}
                            ${todayRecord ? `
                                <div class="flex justify-between">
                                    <span>⏰ Hoy:</span>
                                    <span class="${todayRecord.totalHours >= (employee.workingHours || 8) ? 'text-green-600 font-bold' : 'text-orange-600'}">${todayRecord.totalHours?.toFixed(1) || '0.0'}h</span>
                                </div>
                            ` : ''}
                            <div class="flex justify-between">
                                <span>Días Libres:</span>
                                <span class="font-semibold text-gray-600">${employee.daysOff?.join(', ') || 'Ninguno'}</span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="editEmployee(${employee.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-2 rounded-lg text-xs transition-colors">
                                ✏️ Editar
                            </button>
                            <button onclick="toggleEmployeeStatus(${employee.id})" class="${employee.status === 'Activo' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-green-500 hover:bg-green-600'} text-white px-2 py-2 rounded-lg text-xs transition-colors">
                                ${employee.status === 'Activo' ? '🚫 Desactivar' : '✅ Activar'}
                            </button>
                            <button onclick="deleteEmployee(${employee.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded-lg text-xs transition-colors">
                                🗑️ Eliminar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // FUNCIÓN CLAVE PARA EL FILTRADO
        function filterRecords(records) {
            const filterEmployeeId = document.getElementById('filterEmployee').value;
            const filterStartDate = document.getElementById('filterStartDate').value;
            const filterEndDate = document.getElementById('filterEndDate').value;

            let filteredRecords = records;

            // 1. Filtrar por empleado
            if (filterEmployeeId) {
                filteredRecords = filteredRecords.filter(record => record.employeeId == filterEmployeeId);
            }

            // 2. Filtrar por rango de fechas
            if (filterStartDate && filterEndDate) {
                const start = new Date(filterStartDate);
                const end = new Date(filterEndDate);
                end.setHours(23, 59, 59, 999); 
                
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.date);
                    return recordDate >= start && recordDate <= end;
                });
            }

            return filteredRecords;
        }

        // FUNCIÓN MODIFICADA PARA APLICAR EL FILTRADO Y ALMACENAR DATOS
        function loadTimeRecords() {
            console.log('Cargando y filtrando registros de tiempo');
            const tableElement = document.getElementById('timeRecordsTable');
            if (!tableElement) return;

            let recordsToShow = timeRecords;

            if (currentUser && currentUser.type === 'admin') {
                // Si es administrador, aplicamos los filtros seleccionados
                recordsToShow = filterRecords(recordsToShow);
            } else if (currentUser && currentUser.type === 'employee') {
                // Si es empleado, solo mostramos sus registros
                recordsToShow = recordsToShow.filter(record => record.employeeId === currentUser.id);
            }
            
            recordsToShow = recordsToShow.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Almacenar los datos filtrados en el estado de la app para la exportación
            appState.lastRecordsData = recordsToShow;

            if (recordsToShow.length === 0) {
                tableElement.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">No hay registros disponibles</td></tr>';
                return;
            }
            
            tableElement.innerHTML = recordsToShow.map(record => {
                const statusClass = record.timeOut ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = record.timeOut ? '✅ Completo' : '⏳ En curso';
                
                // Determina si el botón de edición debe ser visible según la variable global
                const editButtonVisibilityClass = isEditModeActive ? 'visible' : '';
                
                const totalHoursDisplay = record.totalHours ? formatHoursToHHMM(record.totalHours) : '00:00';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                    <span class="text-purple-600 font-bold text-xs">
                                        ${record.employeeName.split(' ').map(n => n[0]).join('').substring(0, 2)}
                                    </span>
                                </div>
                                <div>
                                    <span class="font-medium">${record.employeeName}</span>
                                    ${record.location ? `<div class="text-xs text-green-600">${record.location}</div>` : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4">${formatDateDisplay(record.date)}</td>
                        <td class="px-6 py-4 font-mono">${record.timeIn || '--:--'}</td>
                        <td class="px-6 py-4 font-mono">${record.timeOut || '--:--'}</td>
                        <td class="px-6 py-4 font-bold">${totalHoursDisplay}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs rounded-full ${statusClass}">
                                ${statusText}
                            </span>
                        </td>
                        ${currentUser?.type === 'admin' ? `
                            <td class="px-6 py-4">
                                <button onclick="editRecord(${record.id})" class="text-blue-600 hover:text-blue-800 text-sm admin-edit-action ${editButtonVisibilityClass}">
                                    ✏️ Editar
                                </button>
                            </td>
                        ` : ''}
                    </tr>
                `;
            }).join('');
        }

        function loadStatistics() {
            console.log('Cargando estadísticas');
            const statsElement = document.getElementById('statisticsContainer');
            if (!statsElement) return;
            
            const totalRecords = timeRecords.length;
            const totalHours = timeRecords.reduce((sum, record) => sum + (record.totalHours || 0), 0);
            const avgHours = totalRecords > 0 ? totalHours / totalRecords : 0;
            const thisMonth = new Date().toISOString().slice(0, 7);
            const monthRecords = timeRecords.filter(record => record.date.startsWith(thisMonth));
            
            statsElement.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-blue-600">${totalRecords}</div>
                        <div class="text-sm text-gray-600">Total Registros</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-green-600">${formatHoursToHHMM(totalHours)}</div>
                        <div class="text-sm text-gray-600">Total Horas</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-purple-600">${formatHoursToHHMM(avgHours)}</div>
                        <div class="text-sm text-gray-600">Promedio por Día</div>
                    </div>
                    <div class="stat-card">
                        <div class="text-2xl font-bold text-orange-600">${monthRecords.length}</div>
                        <div class="text-sm text-gray-600">Este Mes</div>
                    </div>
                </div>
            `;
        }

        function loadCompanySettings() {
            console.log('Cargando configuración de empresa');
            document.getElementById('companyName').value = companySettings.companyName || '';
            document.getElementById('companyCIF').value = companySettings.companyCIF || '';
            document.getElementById('companyAddress').value = companySettings.companyAddress || '';
            document.getElementById('companyPhone').value = companySettings.companyPhone || '';
        }

        function loadAdminCredentialsForm() {
            console.log('Cargando credenciales de administrador');
            document.getElementById('adminUsername').value = adminCredentials.username || 'admin';
            document.getElementById('currentAdminPassword').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('confirmAdminPassword').value = '';
        }

        function updateDataStatistics() {
            const statsElement = document.getElementById('dataStatistics');
            if (!statsElement) return;
            
            const employeeCount = employees.length;
            const recordCount = timeRecords.length;
            const dataSize = JSON.stringify({employees, timeRecords, companySettings, adminCredentials, locationSettings}).length;
            
            statsElement.innerHTML = `
                <h4 class="font-bold text-gray-800 mb-3">📈 Estadísticas de Datos</h4>
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-blue-600">${employeeCount}</div>
                        <div class="text-sm text-gray-600">Empleados</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-green-600">${recordCount}</div>
                        <div class="text-sm text-gray-600">Registros</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-purple-600">${(dataSize / 1024).toFixed(1)}KB</div>
                        <div class="text-sm text-gray-600">Tamaño</div>
                    </div>
                </div>
            `;
        }
        
        let currentReportData = [];

        function generateReport() {
            console.log('Generando informe');
            const employeeId = document.getElementById('reportEmployee').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            
            const exportBtn = document.getElementById('exportReportBtn');
            exportBtn.classList.add('hidden');
            
            if (!startDate || !endDate) {
                UI.showNotification('⚠️ Seleccione las fechas del informe', 'warning');
                return;
            }
            
            let filteredRecords = timeRecords.filter(record => {
                const recordDate = new Date(record.date);
                const start = new Date(startDate);
                const end = new Date(endDate);
                return recordDate >= start && recordDate <= end;
            });
            
            if (employeeId) {
                filteredRecords = filteredRecords.filter(record => record.employeeId == employeeId);
            }
            
            // Almacenar los datos filtrados para la exportación
            appState.lastReportData = filteredRecords;
            
            const resultsElement = document.getElementById('reportResults');
            if (filteredRecords.length === 0) {
                resultsElement.innerHTML = '<p class="text-gray-500 text-center py-12">No se encontraron registros para el período seleccionado</p>';
                return;
            }
            
            const totalHoursDecimal = filteredRecords.reduce((sum, record) => sum + (record.totalHours || 0), 0);
            const totalHoursDisplay = formatHoursToHHMM(totalHoursDecimal);
            const avgHoursDecimal = totalHoursDecimal / filteredRecords.length;
            const avgHoursDisplay = formatHoursToHHMM(avgHoursDecimal);
            
            resultsElement.innerHTML = `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-800 mb-4">📊 Resumen del Informe</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                        <div class="stat-card">
                            <div class="text-2xl font-bold text-blue-600">${filteredRecords.length}</div>
                            <div class="text-sm text-gray-600">Registros</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-2xl font-bold text-green-600">${totalHoursDisplay}</div>
                            <div class="text-sm text-gray-600">Total Horas</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-2xl font-bold text-purple-600">${avgHoursDisplay}</div>
                            <div class="text-sm text-gray-600">Promedio</div>
                        </div>
                        <div class="stat-card">
                            <div class="text-2xl font-bold text-orange-600">${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}</div>
                            <div class="text-sm text-gray-600">Período</div>
                        </div>
                    </div>
                </div>
                
                <div class="table-modern overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="gradient-bg text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">👤 Empleado</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">📅 Fecha</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">🕐 Entrada</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">🕕 Salida</th>
                                    <th class="px-6 py-4 text-left text-sm font-semibold">⏱️ Total (HH:MM)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${filteredRecords.map(record => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 font-medium">${record.employeeName}</td>
                                        <td class="px-6 py-4">${formatDateDisplay(record.date)}</td>
                                        <td class="px-6 py-4 font-mono">${record.timeIn || '--:--'}</td>
                                        <td class="px-6 py-4 font-mono">${record.timeOut || '--:--'}</td>
                                        <td class="px-6 py-4 font-bold">${formatHoursToHHMM(record.totalHours)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            exportBtn.classList.remove('hidden');
            UI.showNotification('✅ Informe generado correctamente', 'success');
        }
        
        function exportReportData() {
            console.log('Exportando datos del informe actual');
            
            if (appState.lastReportData.length === 0) {
                UI.showNotification('⚠️ Genere un informe primero', 'warning');
                return;
            }

            const csvContent = generateReportCSV(appState.lastReportData);
            downloadFile(csvContent, 'informe_fichaje.csv', 'text/csv');
            UI.showNotification('📊 Informe exportado', 'success');
        }
        
        function generateReportCSV(records) {
            const headers = ['Empleado', 'Fecha', 'Entrada', 'Salida', 'Total Horas (decimal)', 'Total Horas (HH:MM)', 'Notas'];
            const csvRows = [headers.join(',')];
            
            records.forEach(record => {
                const totalHoursDecimal = record.totalHours || 0;
                const totalHoursHHMM = formatHoursToHHMM(totalHoursDecimal);
                
                const row = [
                    `"${record.employeeName}"`,
                    record.date,
                    record.timeIn || '',
                    record.timeOut || '',
                    totalHoursDecimal.toFixed(2),
                    totalHoursHHMM,
                    `"${record.notes || ''}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }


        // Modal Functions
        function showEmployeeModal() {
            document.getElementById('employeeModal').classList.remove('hidden');
            
            // Datos por defecto para el nuevo empleado
            const defaultSchedule = {
                Lunes: { timeIn: '09:00', timeOut: '17:00' }, Martes: { timeIn: '09:00', timeOut: '17:00' }, Miércoles: { timeIn: '09:00', timeOut: '17:00' },
                Jueves: { timeIn: '09:00', timeOut: '17:00' }, Viernes: { timeIn: '09:00', timeOut: '17:00' }, Sábado: { timeIn: null, timeOut: null },
                Domingo: { timeIn: null, timeOut: null }
            };
            const defaultDaysOff = ["Sábado", "Domingo"];


            if (!editingEmployeeId) {
                document.getElementById('employeeName').value = '';
                document.getElementById('employeeLastName').value = '';
                document.getElementById('employeeDNI').value = '';
                document.getElementById('employeePosition').value = '';
                document.getElementById('employeeAccessCode').value = '';
                document.getElementById('employeeWorkingHours').value = '8';
                document.getElementById('employeeCustomHours').value = '';
                document.getElementById('customHoursContainer').classList.add('hidden');
                
                // Renderizar el horario por defecto
                renderEmployeeSchedule(defaultSchedule, defaultDaysOff);

                const modalTitle = document.querySelector('#employeeModal .gradient-bg h3');
                if (modalTitle) {
                    modalTitle.textContent = '👤 Nuevo Empleado';
                }
            }
            
            setTimeout(() => {
                document.getElementById('employeeName').focus();
            }, 100);
        }

        function hideEmployeeModal() {
            document.getElementById('employeeModal').classList.add('hidden');
            editingEmployeeId = null;
            
            const modalTitle = document.querySelector('#employeeModal .gradient-bg h3');
            if (modalTitle) {
                modalTitle.textContent = '👤 Nuevo Empleado';
            }
        }

        function showManualRecordModal() {
            document.getElementById('manualRecordModal').classList.remove('hidden');
            document.getElementById('manualRecordEmployee').value = '';
            document.getElementById('manualRecordDate').value = formatDate(new Date());
            document.getElementById('manualRecordEndDate').value = ''; // Campo nuevo
            document.getElementById('manualRecordTimeIn').value = '';
            document.getElementById('manualRecordTimeOut').value = '';
            document.getElementById('manualRecordNotes').value = '';
            populateManualRecordEmployees();
        }

        function hideManualRecordModal() {
            document.getElementById('manualRecordModal').classList.add('hidden');
        }

        function hideEditRecordModal() {
            document.getElementById('editRecordModal').classList.add('hidden');
            editingRecordId = null;
        }

        function showHelpModal() {
            document.getElementById('helpModal').classList.remove('hidden');
        }

        function hideHelpModal() {
            document.getElementById('helpModal').classList.add('hidden');
        }

        // Save Functions
        function saveEmployee() {
            console.log('Guardando empleado');
            const name = document.getElementById('employeeName').value.trim();
            const lastName = document.getElementById('employeeLastName').value.trim();
            const dni = document.getElementById('employeeDNI').value.trim().toUpperCase();
            const position = document.getElementById('employeePosition').value.trim();
            const accessCode = document.getElementById('employeeAccessCode').value.trim();
            
            if (!name || !lastName || !dni || !accessCode) {
                UI.showNotification('⚠️ Complete todos los campos obligatorios', 'warning');
                return;
            }
            
            if (name.length < 2 || lastName.length < 2) {
                UI.showNotification('⚠️ Nombre y apellidos deben tener al menos 2 caracteres', 'warning');
                return;
            }
            
            // VALIDACIÓN MEJORADA DE DOCUMENTOS (DNI, NIE, Pasaporte Europeo)
            if (!validateDNI_NIE_Passport(dni)) {
                UI.showNotification('⚠️ DNI/NIE/Pasaporte no válido. Verifique el formato.', 'warning');
                return;
            }
            
            if (accessCode.length !== 4 || !/^\d{4}$/.test(accessCode)) {
                UI.showNotification('⚠️ El código PIN debe tener exactamente 4 dígitos', 'warning');
                return;
            }
            
            const existingEmployee = employees.find(emp => 
                (emp.accessCode === accessCode || emp.dni === dni) && 
                emp.id !== editingEmployeeId
            );
            
            if (existingEmployee) {
                if (existingEmployee.accessCode === accessCode) {
                    UI.showNotification('⚠️ Este código PIN ya está en uso', 'warning');
                } else {
                    UI.showNotification('⚠️ Este documento (DNI/NIE) ya está registrado', 'warning');
                }
                return;
            }
            
            const workingHoursSelect = document.getElementById('employeeWorkingHours').value;
            let workingHours;
            
            if (workingHoursSelect === 'custom') {
                const customHours = parseFloat(document.getElementById('employeeCustomHours').value);
                if (!customHours || customHours < 0.5 || customHours > 12) {
                    UI.showNotification('⚠️ Las horas personalizadas deben estar entre 0.5 y 12', 'warning');
                    return;
                }
                workingHours = customHours;
            } else {
                workingHours = parseFloat(workingHoursSelect);
            }

            // --- LÓGICA DE RECOPILACIÓN DE HORARIOS ---
            const newSchedule = {};
            const newDaysOff = [];
            const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            let validationError = false;

            days.forEach(day => {
                const dayOffCheckbox = document.getElementById(`dayOff-${day}`);
                if (dayOffCheckbox && dayOffCheckbox.checked) {
                    newDaysOff.push(day);
                    newSchedule[day] = { timeIn: null, timeOut: null };
                } else {
                    const timeInInput = document.getElementById(`timeIn-${day}`);
                    const timeOutInput = document.getElementById(`timeOut-${day}`);
                    
                    const timeIn = timeInInput ? timeInInput.value : null;
                    const timeOut = timeOutInput ? timeOutInput.value : null;
                    
                    // Usamos el validador de rango con el flag de ScheduleCheck (true)
                    if (timeIn && timeOut && !validateTimeRange(timeIn, timeOut, true)) {
                         UI.showNotification(`⚠️ El turno del ${day} no es válido (máximo 16 horas)`, 'warning');
                         validationError = true;
                    }
                    
                    newSchedule[day] = { timeIn, timeOut };
                }
            });
            
            if (validationError) return;
            // --- FIN LÓGICA DE RECOPILACIÓN DE HORARIOS ---
            
            const employeeData = {
                id: editingEmployeeId || Date.now(),
                name,
                lastName,
                dni,
                position: position || 'Sin especificar',
                status: 'Activo',
                accessCode,
                workingHours, // Horas totales por día
                schedule: newSchedule, // Nuevo: Horario semanal específico
                daysOff: newDaysOff, // Nuevo: Días libres
                createdAt: editingEmployeeId ? employees.find(e => e.id === editingEmployeeId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (editingEmployeeId) {
                const index = employees.findIndex(emp => emp.id === editingEmployeeId);
                if (index !== -1) {
                    employees[index] = { ...employees[index], ...employeeData };
                    UI.showNotification('✅ Empleado actualizado correctamente', 'success');
                }
            } else {
                employees.push(employeeData);
                UI.showNotification('✅ Empleado creado correctamente', 'success');
            }
            
            saveEmployees();
            populateSelects();
            loadEmployees();
            hideEmployeeModal();
        }

        function saveManualRecord() {
            console.log('Guardando registro manual');
            const employeeId = document.getElementById('manualRecordEmployee').value;
            const date = document.getElementById('manualRecordDate').value;
            const endDate = document.getElementById('manualRecordEndDate').value; // Nuevo: Fecha de fin
            const timeIn = document.getElementById('manualRecordTimeIn').value;
            const timeOut = document.getElementById('manualRecordTimeOut').value;
            const notes = document.getElementById('manualRecordNotes').value.trim() || 'Registro manual (Admin)';
            
            if (!employeeId || !date) {
                UI.showNotification('⚠️ Complete los campos obligatorios', 'warning');
                return;
            }
            
            if (!timeIn && !timeOut) {
                UI.showNotification('⚠️ Debe especificar al menos una hora', 'warning');
                return;
            }
            
            // Validar rango de tiempo (máximo 16 horas)
            if (timeIn && timeOut && !validateTimeRange(timeIn, timeOut)) {
                UI.showNotification('⚠️ El rango de tiempo no es válido (máximo 16 horas)', 'warning');
                return;
            }
            
            const startDateObj = new Date(date);
            // Si endDate está vacío, usamos startDate
            const endDateObj = endDate ? new Date(endDate) : startDateObj;
            
            if (startDateObj > endDateObj) {
                UI.showNotification('⚠️ La fecha de inicio no puede ser posterior a la fecha de fin', 'warning');
                return;
            }

            const employee = employees.find(emp => emp.id == employeeId);
            const totalHours = (timeIn && timeOut) ? calculateHours(timeIn, timeOut) : 0;
            const today = new Date();
            let recordsCreated = 0;
            const recordsToSave = [];

            // Iteración para el registro de múltiples días
            // Clonar la fecha inicial para la iteración para evitar modificar la original
            for (let d = new Date(startDateObj); d <= endDateObj; d.setDate(d.getDate() + 1)) {
                const currentDate = formatDate(d);
                const isFutureDate = d > today;

                if (isFutureDate) {
                    UI.showNotification(`⚠️ Se omitió el registro para fecha futura: ${currentDate}`, 'warning');
                    continue;
                }

                const existingRecord = timeRecords.find(record => 
                    record.employeeId == employeeId && record.date === currentDate
                );
                
                if (existingRecord) {
                    // Omitir si ya existe un registro para ese día
                    continue; 
                }

                const newRecord = {
                    id: Date.now() + recordsCreated, // Asegurar ID único
                    employeeId: parseInt(employeeId),
                    employeeName: employee.name + ' ' + employee.lastName,
                    date: currentDate,
                    timeIn: timeIn || null,
                    timeOut: timeOut || null,
                    totalHours,
                    method: 'manual',
                    notes: notes,
                    // ESTANDARIZACIÓN: Si es manual (modo Admin/1010), se considera verificado.
                    location: 'Ubicación verificada ✓ (Admin)', 
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser.name || 'Admin'
                };

                recordsToSave.push(newRecord);
                recordsCreated++;
            }

            if (recordsCreated > 0) {
                timeRecords.push(...recordsToSave);
                saveTimeRecords();
                loadTimeRecords();
                loadDashboard();
                hideManualRecordModal();
                UI.showNotification(`✅ ${recordsCreated} Registro(s) manual(es) creado(s) correctamente`, 'success');
            } else {
                UI.showNotification('⚠️ No se creó ningún registro (ya existían o hubo un error de fechas)', 'warning');
            }
        }

        function saveEditRecord() {
            console.log('Guardando edición de registro');
            if (!editingRecordId) return;
            
            const record = timeRecords.find(r => r.id === editingRecordId);
            if (!record) return;
            
            const date = document.getElementById('editRecordDate').value;
            const timeIn = document.getElementById('editRecordTimeIn').value;
            const timeOut = document.getElementById('editRecordTimeOut').value;
            let notes = document.getElementById('editRecordNotes').value.trim();

            if (!notes) {
                 // Si el administrador edita sin notas, usa una nota estándar
                notes = 'Registro editado por Admin';
            }
            
            record.date = date;
            record.timeIn = timeIn || null;
            record.timeOut = timeOut || null;
            record.totalHours = (timeIn && timeOut) ? calculateHours(timeIn, timeOut) : 0;
            record.notes = notes;
            
            // ESTANDARIZACIÓN: Si se edita en modo edición (código 1010), se considera verificado por Admin.
            if (isEditModeActive) {
                record.location = 'Ubicación verificada ✓ (Editado Admin)';
            }
            
            saveTimeRecords();
            loadTimeRecords();
            loadDashboard();
            hideEditRecordModal();
            UI.showNotification('✅ Registro actualizado', 'success');
        }

        function deleteRecord() {
            console.log('Eliminando registro');
            if (!editingRecordId) return;
            
            if (showConfirmDialog('¿Está seguro de eliminar este registro?')) {
                timeRecords = timeRecords.filter(r => r.id !== editingRecordId);
                saveTimeRecords(); 
                loadTimeRecords();
                loadDashboard();
                hideEditRecordModal();
                UI.showNotification('✅ Registro eliminado', 'success');
            }
        }

        function saveCompanySettingsForm() {
            console.log('Guardando configuración de empresa');
            companySettings.companyName = document.getElementById('companyName').value;
            companySettings.companyCIF = document.getElementById('companyCIF').value;
            companySettings.companyAddress = document.getElementById('companyAddress').value;
            companySettings.companyPhone = document.getElementById('companyPhone').value;
            
            ConfigManager.setCompanySettings(companySettings); 
            UI.showNotification('✅ Configuración guardada', 'success');
        }

        function saveAdminCredentialsForm() {
            console.log('Guardando credenciales de administrador');
            const currentPassword = document.getElementById('currentAdminPassword').value;
            const newUsername = document.getElementById('adminUsername').value.trim();
            const newPassword = document.getElementById('newAdminPassword').value;
            const confirmPassword = document.getElementById('confirmAdminPassword').value;
            
            if (currentPassword !== adminCredentials.password) {
                UI.showNotification('❌ Contraseña actual incorrecta', 'error');
                return;
            }
            
            if (!newUsername) {
                UI.showNotification('⚠️ El nombre de usuario no puede estar vacío', 'warning');
                return;
            }
            
            if (newPassword) {
                if (newPassword.length < 4) {
                    UI.showNotification('⚠️ La nueva contraseña debe tener al menos 4 caracteres', 'warning');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    UI.showNotification('⚠️ Las contraseñas no coinciden', 'warning');
                    return;
                }
                
                adminCredentials.password = newPassword;
            }
            
            adminCredentials.username = newUsername;
            
            DataManager.setAdminCredentials(adminCredentials);
            
            document.getElementById('currentAdminPassword').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('confirmAdminPassword').value = '';
            
            if (currentUser && currentUser.type === 'admin') {
                currentUser.name = newUsername;
            }
            
            UI.showNotification('🔐 Credenciales actualizadas correctamente', 'success');
        }

        // Edit Functions
        function editEmployee(id) {
            console.log('Editando empleado:', id);
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            editingEmployeeId = id;
            
            document.getElementById('employeeName').value = employee.name;
            document.getElementById('employeeLastName').value = employee.lastName;
            document.getElementById('employeeDNI').value = employee.dni;
            document.getElementById('employeePosition').value = employee.position || '';
            document.getElementById('employeeAccessCode').value = employee.accessCode;
            
            // --- Lógica de Horario ---
            const workingHours = employee.workingHours || 8;
            const workingHoursSelect = document.getElementById('employeeWorkingHours');
            const customHoursContainer = document.getElementById('customHoursContainer');
            const customHoursInput = document.getElementById('employeeCustomHours');
            
            const standardHours = ['8', '7', '6', '5', '4', '3', '2'];
            if (standardHours.includes(workingHours.toString())) {
                workingHoursSelect.value = workingHours.toString();
                customHoursContainer.classList.add('hidden');
            } else {
                workingHoursSelect.value = 'custom';
                customHoursInput.value = workingHours;
                customHoursContainer.classList.remove('hidden');
            }
            
            // Renderizar el horario específico del empleado
            const employeeSchedule = employee.schedule || {};
            const employeeDaysOff = employee.daysOff || [];
            renderEmployeeSchedule(employeeSchedule, employeeDaysOff);
            // --- Fin Lógica de Horario ---
            
            const modalTitle = document.querySelector('#employeeModal .gradient-bg h3');
            if (modalTitle) {
                modalTitle.textContent = '✏️ Editar Empleado';
            }
            
            showEmployeeModal();
        }

        function editRecord(id) {
            console.log('Editando registro:', id);
            
            // RESTRICCIÓN DE EDICIÓN EN BASE A isEditModeActive
            if (!isEditModeActive) {
                UI.showNotification('⚠️ Solo disponible en Modo Edición.', 'warning');
                return;
            }
            
            const record = timeRecords.find(r => r.id === id);
            if (!record) return;
            
            editingRecordId = id;
            
            document.getElementById('editRecordEmployeeName').value = record.employeeName;
            document.getElementById('editRecordDate').value = record.date;
            document.getElementById('editRecordTimeIn').value = record.timeIn || '';
            document.getElementById('editRecordTimeOut').value = record.timeOut || '';
            document.getElementById('editRecordNotes').value = record.notes || '';
            
            document.getElementById('editRecordModal').classList.remove('hidden');
        }

        function toggleEmployeeStatus(id) {
            console.log('Cambiando estado de empleado:', id);
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            const newStatus = employee.status === 'Activo' ? 'Inactivo' : 'Activo';
            const action = newStatus === 'Activo' ? 'activar' : 'desactivar';
            
            if (showConfirmDialog(`¿Está seguro de ${action} a ${employee.name} ${employee.lastName}?`)) {
                employee.status = newStatus;
                saveEmployees(); 
                loadEmployees();
                populateSelects();
                UI.showNotification(`✅ Empleado ${newStatus.toLowerCase()}`, 'success');
            }
        }

        async function deleteEmployee(id) {
            console.log('Eliminando empleado:', id);
            const employee = employees.find(emp => emp.id === id);
            if (!employee) return;
            
            const hasRecords = timeRecords.some(record => record.employeeId === id);
            let confirmMessage = `¿Está seguro de eliminar permanentemente a ${employee.name} ${employee.lastName}?`;
            
            if (hasRecords) {
                confirmMessage += '\n\n⚠️ ATENCIÓN: Este empleado tiene registros de fichaje. Al eliminarlo también se eliminarán TODOS sus registros históricos.\n\nEsta acción NO se puede deshacer.';
            }
            
            if (await showConfirmDialog(confirmMessage)) {
                const employeeIndex = employees.findIndex(emp => emp.id === id);
                if (employeeIndex !== -1) {
                    employees.splice(employeeIndex, 1);
                }
                
                if (hasRecords) {
                    timeRecords = timeRecords.filter(record => record.employeeId !== id);
                    saveTimeRecords();
                }
                
                saveEmployees();
                
                loadEmployees();
                loadTimeRecords();
                loadDashboard();
                populateSelects();
                updateDataStatistics();
                
                UI.showNotification('🗑️ Empleado y sus registros eliminados correctamente', 'success');
            }
        }

        // Filter Functions
        function applyFilters() {
            console.log('Aplicando filtros');
            loadTimeRecords();
            UI.showNotification('🔍 Filtros aplicados', 'success');
        }

        // Export Functions
        function exportRecords() {
            console.log('Exportando registros filtrados');
            
            if (appState.lastRecordsData.length === 0) {
                UI.showNotification('⚠️ No hay registros para exportar', 'warning');
                return;
            }
            
            const csvContent = generateReportCSV(appState.lastRecordsData);
            downloadFile(csvContent, 'registros_filtrados_fichaje.csv', 'text/csv');
            UI.showNotification('📊 Registros exportados', 'success');
        }

        function exportAllData() {
            console.log('Exportando todos los datos');
            const allData = {
                employees,
                timeRecords,
                companySettings,
                adminCredentials,
                locationSettings,
                exportDate: new Date().toISOString()
            };
            const jsonContent = JSON.stringify(allData, null, 2);
            downloadFile(jsonContent, 'fichajemax_backup.json', 'application/json');
            UI.showNotification('💾 Backup completo exportado', 'success');
        }

        // Import Functions
        function handleImportFile(event) {
            console.log('Importando archivo');
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.employees) employees = data.employees;
                    if (data.timeRecords) timeRecords = data.timeRecords;
                    if (data.companySettings) companySettings = data.companySettings;
                    if (data.adminCredentials) adminCredentials = data.adminCredentials;
                    if (data.locationSettings) locationSettings = data.locationSettings;
                    
                    DataManager.setEmployees(employees);
                    DataManager.setTimeRecords(timeRecords);
                    ConfigManager.setCompanySettings(companySettings);
                    DataManager.setAdminCredentials(adminCredentials);
                    ConfigManager.setLocationSettings(locationSettings);
                    
                    loadEmployees();
                    loadTimeRecords();
                    loadDashboard();
                    populateSelects();
                    updateDataStatistics();
                    
                    UI.showNotification('✅ Datos importados correctamente', 'success');
                } catch (error) {
                    console.error('Error importing data:', error);
                    UI.showNotification('❌ Error al importar datos', 'error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            console.log('Limpiando todos los datos');
            if (showConfirmDialog('¿Está seguro de eliminar TODOS los datos? Esta acción no se puede deshacer.')) {
                employees.length = 0;
                timeRecords.length = 0;
                
                DataManager.setEmployees([]);
                DataManager.setTimeRecords([]);
                
                loadEmployees();
                loadTimeRecords();
                loadDashboard();
                populateSelects();
                updateDataStatistics();
                
                UI.showNotification('🗑️ Todos los datos han sido eliminados', 'success');
            }
        }

        // Notification Functions
        function showConfirmDialog(message) {
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.style.zIndex = '9999';
            
            const modal = document.createElement('div');
            modal.className = 'modal-content';
            modal.style.maxWidth = '400px';
            modal.innerHTML = `
                <div class="gradient-bg text-white p-6 rounded-t-2xl">
                    <h3 class="text-xl font-bold">⚠️ Confirmación</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-700 mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirmCancel" class="px-6 py-2 text-gray-600 hover:text-gray-800 transition-colors">
                            ❌ Cancelar
                        </button>
                        <button id="confirmAccept" class="btn-primary text-white px-6 py-2 rounded-lg">
                            ✅ Confirmar
                        </button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            return new Promise((resolve) => {
                document.getElementById('confirmCancel').addEventListener('click', () => {
                    overlay.remove();
                    resolve(false);
                });
                
                document.getElementById('confirmAccept').addEventListener('click', () => {
                    overlay.remove();
                    resolve(true);
                });
                
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                        resolve(false);
                    }
                });
            });
        }

        // NOTA: Esta función se usa para exportar registros filtrados Y para exportar informes.
        function generateReportCSV(records) {
            const headers = ['Empleado', 'Fecha', 'Entrada', 'Salida', 'Total Horas (decimal)', 'Total Horas (HH:MM)', 'Notas'];
            const csvRows = [headers.join(',')];
            
            records.forEach(record => {
                const totalHoursDecimal = record.totalHours || 0;
                const totalHoursHHMM = formatHoursToHHMM(totalHoursDecimal);
                
                const row = [
                    `"${record.employeeName}"`,
                    record.date,
                    record.timeIn || '',
                    record.timeOut || '',
                    totalHoursDecimal.toFixed(2),
                    totalHoursHHMM,
                    `"${record.notes || ''}"`
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function setDefaultDates() {
            const today = formatDate(new Date());
            const weekAgo = formatDate(new Date(Date.now() - 7 * 24 * 60 * 60 * 1000));
            
            const reportStartDate = document.getElementById('reportStartDate');
            const reportEndDate = document.getElementById('reportEndDate');
            const filterStartDate = document.getElementById('filterStartDate');
            const filterEndDate = document.getElementById('filterEndDate');
            
            if (reportStartDate) reportStartDate.value = weekAgo;
            if (reportEndDate) reportEndDate.value = today;
            if (filterStartDate) filterStartDate.value = weekAgo;
            if (filterEndDate) filterEndDate.value = today;
        }

        // Cloud Sync Functions (Ahora solo son un 'placeholder' para el UI de settings)
        function testCloudConnection() {
            UI.showNotification('✅ Conexión establecida con Firebase', 'success');
            updateCloudStatus(true, 'Conexión activa y en tiempo real');
        }

        function syncNow() {
            DataManager.setEmployees(employees);
            DataManager.setTimeRecords(timeRecords);
            ConfigManager.setCompanySettings(companySettings);
            ConfigManager.setLocationSettings(locationSettings);
            
            UI.showNotification('☁️ Sincronización manual completada (usando Firebase)', 'success');
        }

        function updateCloudStatus(isConnected, message) {
            const statusElement = document.getElementById('cloudStatus');
            if (!statusElement) return;
            
            statusElement.classList.remove('hidden');
            if (isConnected) {
                statusElement.innerHTML = `<span class="text-green-600">✅ ${message}</span>`;
                statusElement.className = 'p-3 rounded-lg bg-green-100 text-sm';
            } else {
                statusElement.innerHTML = `<span class="text-red-600">❌ ${message}</span>`;
                statusElement.className = 'p-3 rounded-lg bg-red-100 text-sm';
            }
        }

        function updateCloudSyncStatus() {
            const statusElement = document.getElementById('cloudSyncStatus');
            if (!statusElement) return;
            
            const lastSyncText = new Date().toLocaleTimeString('es-ES');
                
            statusElement.innerHTML = `
                <div class="text-green-700">
                    <strong>Estado:</strong> 🚀 Sincronización Ultra-Rápida Activa (Firebase)<br>
                    <strong>Última verificación:</strong> ${lastSyncText}<br>
                    <strong>Frecuencia:</strong> **En tiempo real** (Instantánea)<br>
                    <strong>Dispositivos:</strong> Cambios instantáneos en móviles, tablets y ordenadores<br>
                    <strong>Rendimiento:</strong> Optimizado para múltiples dispositivos simultáneos
                </div>
            `;
            statusElement.className = 'p-3 rounded-lg bg-green-100 text-sm';
        }

        function loadCloudSettings() {
            document.getElementById('cloudApiKey').value = '********';
            document.getElementById('cloudBinId').value = '********';
            
            document.getElementById('cloudApiKey').disabled = true;
            document.getElementById('cloudBinId').disabled = true;
            document.getElementById('enableAutoSync').checked = true;
            document.getElementById('enableAutoSync').disabled = true;
            document.getElementById('syncInterval').disabled = true;
            document.getElementById('saveCloudSettings').disabled = true;
            document.getElementById('syncIntervalValue').textContent = 'Tiempo Real';

            updateCloudSyncStatus();
        }

        function saveCloudSettingsForm() {
            UI.showNotification('⚠️ La sincronización usa Firebase y se configura automáticamente. Los campos de JSONBin ya no se usan.', 'warning');
        }

        // Data persistence functions con Firebase
        function saveEmployees() {
            DataManager.setEmployees(employees);
        }

        function saveTimeRecords() {
            DataManager.setTimeRecords(timeRecords);
        }

        function saveCompanySettings() {
            ConfigManager.setCompanySettings(companySettings);
        }

        function saveAdminCredentialsData() {
            DataManager.setAdminCredentials(adminCredentials);
        }

        // Utility Functions
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateDisplay(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', { 
                weekday: 'short', 
                day: 'numeric', 
                month: 'short' 
            });
        }
        
        // Convierte horas decimales a formato HH:MM
        function formatHoursToHHMM(hoursDecimal) {
            if (hoursDecimal === null || hoursDecimal === undefined || isNaN(hoursDecimal)) {
                return '00:00';
            }
            const totalMinutes = Math.round(hoursDecimal * 60);
            const sign = totalMinutes < 0 ? "-" : "";
            const absTotalMinutes = Math.abs(totalMinutes);
            const hours = Math.floor(absTotalMinutes / 60);
            const minutes = absTotalMinutes % 60;
            
            const hoursStr = String(hours).padStart(2, '0');
            const minutesStr = String(minutes).padStart(2, '0');
            
            return `${sign}${hoursStr}:${minutesStr}`;
        }


        function calculateHours(timeIn, timeOut) {
            const [inHour, inMinute] = timeIn.split(':').map(Number);
            const [outHour, outMinute] = timeOut.split(':').map(Number);
            
            const inMinutes = inHour * 60 + inMinute;
            let outMinutes = outHour * 60 + outMinute;
            
            let diffMinutes = outMinutes - inMinutes;
            if (diffMinutes < 0) diffMinutes += 24 * 60; 
            
            return diffMinutes / 60;
        }

        function populateSelects() {
            const activeEmployees = employees.filter(emp => emp.status === 'Activo');
            
            const clockSelect = document.getElementById('clockEmployeeSelect');
            if (clockSelect) {
                clockSelect.innerHTML = '<option value="">Seleccionar empleado</option>' +
                    activeEmployees.map(emp => 
                        `<option value="${emp.id}">${emp.name} ${emp.lastName}</option>`
                    ).join('');
            }
            
            const manualSelect = document.getElementById('manualRecordEmployee');
            if (manualSelect) {
                manualSelect.innerHTML = '<option value="">Seleccionar empleado</option>' +
                    activeEmployees.map(emp => 
                        `<option value="${emp.id}">${emp.name} ${emp.lastName}</option>`
                    ).join('');
            }
            
            const reportSelect = document.getElementById('reportEmployee');
            if (reportSelect) {
                reportSelect.innerHTML = '<option value="">Todos los empleados</option>' +
                    activeEmployees.map(emp => 
                        `<option value="${emp.id}">${emp.name} ${emp.lastName}</option>`
                    ).join('');
            }
            
            const filterSelect = document.getElementById('filterEmployee');
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">Todos los empleados</option>' +
                    activeEmployees.map(emp => 
                        `<option value="${emp.id}">${emp.name} ${emp.lastName}</option>`
                    ).join('');
            }
        }

        function populateManualRecordEmployees() {
            const select = document.getElementById('manualRecordEmployee');
            const activeEmployees = employees.filter(emp => emp.status === 'Activo');
            
            select.innerHTML = '<option value="">Seleccionar empleado</option>' +
                activeEmployees.map(emp => 
                    `<option value="${emp.id}">${emp.name} ${emp.lastName}</option>`
                ).join('');
        }
        
        // Función de Validación de Documentos Mejorada (DNI/NIE/Pasaporte)
        function validateDNI_NIE_Passport(doc) {
            doc = doc.toUpperCase().replace(/\s/g, ''); // Limpia espacios y convierte a mayúsculas

            // 1. DNI (8 dígitos + 1 letra)
            const dniRegex = /^(\d{8})([A-Z])$/;
            const dniLetters = 'TRWAGMYFPDXBNJZSQVHLCKE';
            if (dniRegex.test(doc)) {
                const parts = doc.match(dniRegex);
                const number = parseInt(parts[1]);
                const letter = parts[2];
                return letter === dniLetters[number % 23];
            }

            // 2. NIE (X/Y/Z + 7 dígitos + 1 letra)
            const nieRegex = /^([XYZ])(\d{7})([A-Z])$/;
            if (nieRegex.test(doc)) {
                const parts = doc.match(nieRegex);
                const prefix = parts[1];
                const numberStr = parts[2];
                const letter = parts[3];
                const prefixMap = { 'X': '0', 'Y': '1', 'Z': '2' };
                const number = parseInt(prefixMap[prefix] + numberStr);
                return letter === dniLetters[number % 23];
            }
            
            // 3. Validación de Pasaporte/ID Europeo (Más flexible para documentos que no son DNI/NIE)
            // Acepta documentos alfanuméricos comunes de 6 a 12 caracteres.
            const passportRegex = /^[A-Z0-9]{6,12}$/;
            if (passportRegex.test(doc)) {
                return true;
            }

            return false;
        }

        // Renombrar la antigua función validateDNI para usar la nueva
        function validateDNI(dni) { 
            return validateDNI_NIE_Passport(dni); 
        }

        // Utility function to render schedule form fields
        function renderEmployeeSchedule(schedule, daysOff) {
            const container = document.getElementById('employeeScheduleContainer');
            if (!container) return;
            
            const days = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
            container.innerHTML = days.map(day => {
                const dayKey = day;
                const timeIn = schedule[dayKey]?.timeIn || '';
                const timeOut = schedule[dayKey]?.timeOut || '';
                const isDayOff = daysOff.includes(day);
                
                return `
                    <div class="grid grid-cols-5 gap-3 items-center p-2 rounded-lg ${isDayOff ? 'bg-gray-100' : 'bg-white border'}">
                        <div class="col-span-2 flex items-center space-x-2">
                            <input type="checkbox" id="dayOff-${dayKey}" data-day="${dayKey}" onchange="toggleDayOff('${dayKey}')" ${isDayOff ? 'checked' : ''} class="rounded text-purple-600 focus:ring-purple-500">
                            <label for="dayOff-${dayKey}" class="text-sm font-medium text-gray-700">${day}</label>
                        </div>
                        <input type="time" id="timeIn-${dayKey}" value="${timeIn}" data-day="${dayKey}" class="input-modern col-span-1 text-sm ${isDayOff ? 'bg-gray-200' : 'bg-white'}" ${isDayOff ? 'disabled' : ''}>
                        <span class="text-center text-gray-500 text-sm">-</span>
                        <input type="time" id="timeOut-${dayKey}" value="${timeOut}" data-day="${dayKey}" class="input-modern col-span-1 text-sm ${isDayOff ? 'bg-gray-200' : 'bg-white'}" ${isDayOff ? 'disabled' : ''}>
                    </div>
                `;
            }).join('');
        }

        function toggleDayOff(dayKey) {
            const isChecked = document.getElementById(`dayOff-${dayKey}`).checked;
            document.getElementById(`timeIn-${dayKey}`).disabled = isChecked;
            document.getElementById(`timeOut-${dayKey}`).disabled = isChecked;
            
            // Opcional: limpiar los valores si es día libre
            if (isChecked) {
                document.getElementById(`timeIn-${dayKey}`).value = '';
                document.getElementById(`timeOut-${dayKey}`).value = '';
            }
        }
        
        function validateTimeRange(timeIn, timeOut, isScheduleCheck = false) {
            if (!timeIn || !timeOut) return true;
            
            const [inHour, inMinute] = timeIn.split(':').map(Number);
            const [outHour, outMinute] = timeOut.split(':').map(Number);
            
            const inMinutes = inHour * 60 + inMinute;
            let outMinutes = outHour * 60 + outMinute;
            
            let diffMinutes = outMinutes - inMinutes;
            
            // Si el tiempo de salida es anterior al de entrada, asume que es un turno nocturno (pasa al día siguiente)
            if (diffMinutes < 0) {
                diffMinutes += 24 * 60; // Añadimos un día entero para calcular las horas correctamente.
            }

            // Máximo de 16 horas (960 minutos) por turno o registro
            return diffMinutes <= 16 * 60;
        }

        function setupActivityMonitoring() {
            const INACTIVITY_TIMEOUT = 30 * 60 * 1000; 
            
            function resetActivity() {
                lastActivity = Date.now();
            }
            
            function checkInactivity() {
                if (currentUser && Date.now() - lastActivity > INACTIVITY_TIMEOUT) {
                    UI.showNotification('⏰ Sesión cerrada por inactividad', 'warning');
                    logout();
                }
            }
            
            ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
                document.addEventListener(event, resetActivity, true);
            });
            
            setInterval(checkInactivity, 60000);
            
            setupAutoSave();
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if (!currentUser) return;

                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'e':
                            e.preventDefault();
                            if (currentUser.type === 'admin') {
                                showEmployeeModal();
                            }
                            break;
                        case 'r':
                            e.preventDefault();
                            if (currentUser.type === 'admin') {
                                showManualRecordModal();
                            }
                            break;
                        case 's':
                            e.preventDefault();
                            syncNow();
                            UI.showNotification('💾 Datos guardados', 'success');
                            break;
                    }
                }
                
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal-overlay:not(.hidden)');
                    modals.forEach(modal => modal.classList.add('hidden'));
                    editingRecordId = null;
                    editingEmployeeId = null;
                }
                
                if (currentUser.type === 'employee') {
                    if (e.key === 'F1') {
                        e.preventDefault();
                        clockAction('in');
                    } else if (e.key === 'F2') {
                        e.preventDefault();
                        clockAction('out');
                    }
                }
            });
        }

        function setupAutoSave() {
            autoSaveTimer = setInterval(() => {
                if (currentUser) {
                    saveEmployees();
                    saveTimeRecords();
                }
            }, 120000);
        }

        function formatTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMins / 60);
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffMins < 1) return 'Ahora mismo';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            if (diffHours < 24) return `Hace ${diffHours}h`;
            if (diffDays < 7) return `Hace ${diffDays} días`;
            return formatDateDisplay(dateString);
        }

        function generateRandomPIN() {
            let pin;
            do {
                pin = Math.floor(1000 + Math.random() * 9000).toString();
            } while (employees.some(emp => emp.accessCode === pin));
            return pin;
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9907ba73137aec95',t:'MTc2MDc4NzI4NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
